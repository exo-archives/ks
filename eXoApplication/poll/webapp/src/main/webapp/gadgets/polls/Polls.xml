<?xml version="1.0" encoding="UTF-8" ?>
<Module>
	<ModulePrefs author="eXoPlatform"
		title="Poll"
		directory_title="Polls"
		title_url="http://www.exoplatform.org"
		description="Poll list."
		thumbnail="/poll/gadgets/polls/skin/thumb.png"
		height="300">
		<Locale messages="/poll/gadgets/polls/locale/default.xml" />
		<Locale lang="ar" messages="/poll/gadgets/polls/locale/ar.xml" language_direction="rtl"/>
		<Locale lang="fr" messages="/poll/gadgets/polls/locale/fr.xml" />
		<Locale lang="vi" messages="/poll/gadgets/polls/locale/vi.xml" />
		<Require feature="setprefs"/>
	</ModulePrefs>
	<UserPref name="pollId" display_name="pollId of poll you show." datatype="string" default_value="" required="true"/>
	 
	<Content type="html">
		<![CDATA[
			<script type="text/javascript">
		 		document.write("<link rel='stylesheet' type='text/css' href='/poll/skin/DefaultSkin/webui/Stylesheet.css'/> <link rel='stylesheet' type='text/css' href='/eXoResources/skin/DefaultSkin/webui/component/Stylesheet.css'/> ");
			</script>
	
			<div class="UIPollPortlet" style="padding:0px 5px 5px 5px; height:280px; overflow:auto;">
						
				<div class="UITopicPoll" id="UITopicPoll">
					<div class="ForumToolbar">
						<div class="LeftBar">
							<div class="RightBar">
								<div class="CenterBar">
									<div class="Lable Question">
										<span>__MSG_poll__</span>
										<span class="question"></span>
									</div>
									<div class="CollapseButton" title="Edit" onclick="editUserPrefs()"><span></span></div>
								
									<div style="clear:both"><span></span></div>
								</div>
							</div>
						</div>
					</div>
					
					<div class="TopicPollContainer">
						
						<div class="UIFormTabPane">
							<div class="UITabPane">
								<div class="TabPaneContent">
									<div class="WorkingArea">
									 	<div class="HorizontalLayout">
											<div class="UITabContentContainer">
											  
												<div class="UITabContent">
												
												
													<div class="TopicPollContent" id="TopicPollContent" style="display:none;">
														<div class="PollQuestion"><span class="question"></span></div>
														<div class="UIForm">
															<div class="HorizontalLayout">
																<div class="FormContainer">
																	<table class="UIFormGrid">
																		<tbody>
																			<tr>
																				<td class="FieldComponent" style="white-space:normal;">
																					<div id="options"></div>
																				</td>
																			</tr>
																		</tbody>
																	</table>
																	<div class="UIAction">
																		<table class="ActionContainer">
																			<tbody>
																				<tr>
																					<td align="center">
																						<div class="ActionButton LightBlueStyle">
																							<div class="ButtonLeft">
																								<div class="ButtonRight">
																									<div class="ButtonMiddle" style="display:block">
																										<a onclick="voteNow();">__MSG_voteNow__</a>
																									</div>
																								</div>
																							</div>
																						</div>
																					</td>
																				</tr>
																			</tbody>
																		</table>
																	</div>
																	
																</div>
															</div>
														</div>
													</div>
													
													<div class="ViewPollForm" id="ViewPollForm" style="display:none;">
														<table cellspacing="0" cellpadding="0" border="0" class="UIGrid" id="UIGrid">
															<thead>
																<tr>
																	<th>__MSG_options__</th>
																	<th style="width: 35%">__MSG_percentage__</th>
																	<th style="width: 100px;">__MSG_votes__</th>
																</tr>
															</thead>
															<tbody id="dataTable">
															
															</tbody>
														</table>
														<div class="TotalVotes">__MSG_totalVoters__ <span id="sunVote"></span></div>
													</div>

													<div style="display:none;" class="EditPoll" id="EditPoll"><span></span></div>
													<div style="display:none;" id="comment">You must edit poll and use some pollId for config Poll gadget</div>
												</div>
												
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						
					</div>
				</div>
				<div style="display:none;" class="MenuPollId" id="MenuPollId"><span></span></div>
			</div>
			
			<script type="text/javascript">
				parent.eXo.require("eXo.core.JSON");
				var displayData = "none";
				var displayView = "node";
				
				String.prototype.trim = function () {
    			return this.replace(/^\s*/, "").replace(/\s*$/, "");
				}

				function createRequestUrl(){
					var prefs = new gadgets.Prefs();
					var pollId = prefs.getString("pollId");
					var url = "/portal/rest/private/ks/poll/viewpoll/"; 
					if(pollId) {
						pollId = new String(pollId);
						url = url + pollId.trim() ;
					} else url = url + "pollid" ;
					return url;
				}
				
				// render data.
				function render(data){
					var tpPoll = document.getElementById("TopicPollContent");
					var viewPoll = document.getElementById("ViewPollForm");
					var comment = document.getElementById("comment");
					if(data) {
						if(data.id == "Empty") {
							var editPoll = document.getElementById("AddPollIdIcon");
							if(editPoll) comment.style.display = "none";
							else comment.style.display = "block";
							buildMenu(data);
						} else {
							comment.style.display = "none";
							if(data.showVote) {
								tpPoll.style.display = "none";
								viewPoll.style.display = "block";
								innerData("span", "question", data.question);
								innerTableData(data);
							} else {
								tpPoll.style.display = "block";
								viewPoll.style.display = "none";
								innerData("span", "question", data.question);
								innerRadioData("options", data) ;
								displayView = "node";
							}
						}
					}
				}
				
				function buildMenu(data) {
					var ids = data.listId;
					var str = "";
					for(var i = 0; i < ids.length; ++ i) {
						str = str + 
						'<div class="MenuItem"><a onclick="selectedItem(this);">'+ids[i] + '</a></div>';
					}
					innerData("div", "MenuPollId", str);
				}
				
				function innerData(type, clasElm, vl) {
					var elms = document.getElementsByTagName(type);
					for(var i = 0; i < elms.length; ++ i) {
						if(elms[i].className === clasElm) elms[i].innerHTML = vl;
					}
				}
				
				function innerRadioData(idElm, data) {
					var options = data.option;
					var str = "<form>";
					for(var i = 0; i < options.length; ++ i) {
						str = str + '<div><input class="radio" type="radio" name="vote" value="' + options[i] + '"> <span>' + options[i] + '</span></div>';
					}
					str = str + "</form>";
					document.getElementById(idElm).innerHTML = str;
				}
				
				
				function innerTableData(data) {
					var options = data.option;
					var infoVote = data.infoVote;
					var colors = ["blue", "DarkGoldenRod", "green", "yellow", "BlueViolet", "orange", "darkBlue", "IndianRed", "DarkCyan", "lawnGreen"];
					var classCss = "OddRow" ;
					var str = "";
					var percen = "10%";
					var voteNumber = 2;
					for(var i = 0; i < options.length; ++ i) {
						var number = infoVote[i].split(":") ;
						percen = number[0];
						str = str +
						'<tr class="' + classCss + '">' +
							'<td class="text">' + options[i] + '</span></td>' +
							'<td>' +
								'<table class="Percen">' +
									'<tbody>' +
										'<tr>' +
											'<td class="BackgroudColor">' +
												'<div style="background-color:' + colors[i] + '; width: ' + percen + '%;" class="Chart"><span></span></div>' +
											'</td>' +
											'<td class="Percentage">' +
												'<div>' + percen +'%</div>' +
											'</td>' +
										'</tr>' +
									'</tbody>' +
								'</table>' +
							'</td>' +
							'<td class="Number">' + number[1] + '</td>' +
						'</tr>';
						if(i%2 == 0) classCss = "EvenRow" ;
						else classCss = "OddRow";
					}
					document.getElementById("dataTable").innerHTML = str;
					document.getElementById("sunVote").innerHTML = infoVote[(infoVote.length-1)];
				}
				// get data
				function getData(){					 
					var url = createRequestUrl();		
					ajaxAsyncGetRequest(url,render);
				}
				
				
				// vote 
				function voteNow() {
					var radios = document.getElementsByTagName('input');
					if(radios) {
						for(var i = 0; i < radios.length; ++ i) {
							if(radios[i].checked){
								var url = createRequestUrl() + "/" + i;
								url = String(url).replace("viewpoll", "votepoll");
								ajaxAsyncGetRequest(url,render);
								break;
							}
						}
					}
				}
				
				// save pollId
				function editUserPrefs() {
					document.getElementById("TopicPollContent").style.display = "none";
					document.getElementById("ViewPollForm").style.display = "none";
					var parent = document.getElementById("EditPoll");
					parent.style.display = "block";
					var str =
					'<form>'+
						'<div style="padding: 8px 0px;">'+
							'<div style="float:left;"><span style="padding-right: 10px;">Poll Id: </span><input id="m_pollId" name="m_10_up_pollId"/></div>'+
							'<div class="AddPollIdIcon" id="AddPollIdIcon" title="Add poll id." onclick="showMenu()"><span></span></div>'+
							'<div style="float:left; position:relative;" id="MenuContent"><span></span></div>'+
							'<div style="clear:left;"><span></span></div>'+
						'</div>'+
					'</form>'+
					'<div class="ActionBar">'+
						'<input value="Save" onclick="saveUserPrefs()" type="button"/>'+
						'<input value="Cancel" onclick="cancelUserPrefs()" type="button"/>'+
					'</div>';
					parent.innerHTML = str;
					var input = document.getElementById("m_pollId");
					if(input) {
						input.value = gadgets.Prefs().getString("pollId");
					}
					ajaxAsyncGetRequest("/portal/rest/private/ks/poll/viewpoll/pollId",render);
				}
				
				function showMenu() {
					var parent = document.getElementById("MenuContent");
					var child = document.getElementById("MenuPollId");
					parent.innerHTML = '<div class="MenuPollId">' + child.innerHTML + '</div>';
				}
				
				function selectedItem(elm) {
					var input = document.getElementById("m_pollId");
					if(input) {
						input.value = elm.innerHTML;
						var parent = document.getElementById("MenuContent");
						parent.innerHTML = "";
					}
					
				}
				
				function saveUserPrefs() {
					var input = document.getElementById("m_pollId");
					if(input) {
						var pollId = input.value;
						if(pollId) {
							var prefs = new gadgets.Prefs();
							prefs.set("pollId", pollId);
							document.getElementById("EditPoll").innerHTML = "";
						}
					}
				}
				
				function cancelUserPrefs() {
					document.getElementById("EditPoll").innerHTML = "";
					getData();
				}
				
				// load hander
				function onLoadHander(){
					setInterval(getData,5000);
				}
				function ajaxAsyncGetRequest(url, render) {
					var request =	parent.eXo.core.Browser.createHttpRequest() ;
					request.open('GET', url, true) ;
					request.setRequestHeader("Cache-Control", "max-age=86400") ;
					request.send(null) ;
					request.onreadystatechange = function(){
						var data = request.responseText;
						render(gadgets.json.parse(data));
					}					
				}
				gadgets.util.registerOnLoadHandler(getData);
			</script>
			
		]]>
	</Content>
</Module>