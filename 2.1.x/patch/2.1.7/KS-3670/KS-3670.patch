Index: eXoApplication/faq/service/src/main/java/org/exoplatform/faq/service/impl/FAQServiceImpl.java
===================================================================
--- eXoApplication/faq/service/src/main/java/org/exoplatform/faq/service/impl/FAQServiceImpl.java	(revision 76510)
+++ eXoApplication/faq/service/src/main/java/org/exoplatform/faq/service/impl/FAQServiceImpl.java	(working copy)
@@ -48,6 +48,7 @@
 import org.exoplatform.faq.service.Utils;
 import org.exoplatform.faq.service.Watch;
 import org.exoplatform.ks.bbcode.core.BBCodeServiceImpl;
+import org.exoplatform.ks.common.CommonUtils;
 import org.exoplatform.ks.common.NotifyInfo;
 import org.exoplatform.ks.common.jcr.KSDataLocation;
 import org.exoplatform.management.annotations.ManagedBy;
@@ -172,17 +173,13 @@
 	    log.warn("No default template was configured for FAQ.");
 	    return;
 	  }
-	  SessionProvider provider = SessionProvider.createSystemProvider();
-	  try {
+	  SessionProvider provider = CommonUtils.createSystemProvider();
 	  	if(!locator.getSessionManager().getSession(provider).getRootNode().hasNode(locator.getFaqTemplatesLocation()+"/"+Utils.UI_FAQ_VIEWER)) {
 	  		InputStream in = configManager_.getInputStream(template_.getPath()) ;
 	  		byte[] data = new byte[in.available()] ;
 	  		in.read(data) ;
 	  		saveTemplate(new String(data)) ;
 	  	}
-		} finally {
-			provider.close();
-		}
 		configManager_ = null ;
 		template_ = null ;
 	}
@@ -1163,91 +1160,91 @@
 	}
 	
 	public void addLanguage(String questionPath, QuestionLanguage language) throws Exception{
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = jcrData_.getFAQServiceHome(sProvider).getNode(questionPath) ;
       MultiLanguages.addLanguage(questionNode, language) ;
     } catch (Exception e) {
       log.error("Fail to add language: ", e);
-    }finally {sProvider.close() ;}
+    }
   }
   
   public void deleteAnswerQuestionLang(String questionPath, String answerId, String language) throws Exception{  	
-  	SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+  	SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = jcrData_.getFAQServiceHome(sProvider).getNode(questionPath) ;
       MultiLanguages.deleteAnswerQuestionLang(questionNode, answerId, language) ;
     } catch (Exception e) {
       log.error("Fail to delete " + answerId + " :", e);
-    }finally {sProvider.close() ;}
+    }
   }
   
   public void deleteCommentQuestionLang(String questionPath, String commentId, String language) throws Exception{
-  	SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+  	SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = jcrData_.getFAQServiceHome(sProvider).getNode(questionPath) ;
       MultiLanguages.deleteCommentQuestionLang(questionNode, commentId, language) ;
     } catch (Exception e) {
       log.error("Fail to delete "+ commentId + " comment question", e);
-    }finally {sProvider.close() ;}
+    }
   }
   
   public QuestionLanguage getQuestionLanguageByLanguage(String questionPath, String language) throws Exception{
-  	SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+  	SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = jcrData_.getFAQServiceHome(sProvider).getNode(questionPath) ;
       return MultiLanguages.getQuestionLanguageByLanguage(questionNode, language) ;
     } catch (Exception e) {
       throw e;
-    }finally {sProvider.close() ;}
+    }
   }
   
   public Comment getCommentById(String questionPath, String commentId, String language) throws Exception{
-  	SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+  	SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = jcrData_.getFAQServiceHome(sProvider).getNode(questionPath) ;
       return MultiLanguages.getCommentById(questionNode, commentId, language) ;
     } catch (Exception e) {
       log.error("Fail to get comment", e);
-    }finally {sProvider.close() ;}
+    }
     return null ;
   }
   
   public Answer getAnswerById(String questionPath, String answerid, String language) throws Exception{
-  	SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+  	SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = jcrData_.getFAQServiceHome(sProvider).getNode(questionPath) ;
       return MultiLanguages.getAnswerById(questionNode, answerid, language) ;
     } catch (Exception e) {
       log.error("Fail to get answer: " + e.getMessage());
-    }finally {sProvider.close() ;}
+    }
     return null ;
   }
   
   
   
   public void saveAnswer(String questionPath, Answer answer, String language) throws Exception{
-  	SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+  	SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = jcrData_.getFAQServiceHome(sProvider).getNode(questionPath) ;
       MultiLanguages.saveAnswer(questionNode, answer, language) ;
     } catch (Exception e) {
       log.error("Fail to save answer:", e);
-    }finally {sProvider.close() ;}
+    }
   }
   
   public void saveAnswer(String questionPath, QuestionLanguage questionLanguage) throws Exception{
-  	SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+  	SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = jcrData_.getFAQServiceHome(sProvider).getNode(questionPath) ;
       MultiLanguages.saveAnswer(questionNode, questionLanguage) ;
     } catch (Exception e) {
       log.error("Fail to save answer: ", e);
-    }finally {sProvider.close() ;}
+    }
   }
   
   public void saveComment(String questionPath, Comment comment, String languge) throws Exception{
-  	SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+  	SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = jcrData_.getFAQServiceHome(sProvider).getNode(questionPath) ;
       MultiLanguages.saveComment(questionNode, comment, languge) ;
@@ -1256,48 +1253,48 @@
       }
     } catch (Exception e) {
       log.error("\nFail to save comment\n ", e);
-    }finally {sProvider.close() ;}
+    }
   }
   
   
   public void removeLanguage(String questionPath, List<String> listLanguage) {
-  	SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+  	SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = jcrData_.getFAQServiceHome(sProvider).getNode(questionPath) ;
       MultiLanguages.removeLanguage(questionNode, listLanguage) ;
     } catch (Exception e) {
       log.error("\nFail to remove language\n" , e);
-    }finally {sProvider.close() ;}
+    }
   }  
   
   public void voteAnswer(String answerPath, String userName, boolean isUp) throws Exception {
-  	SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+  	SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node answerNode = jcrData_.getFAQServiceHome(sProvider).getNode(answerPath) ;
       MultiLanguages.voteAnswer(answerNode, userName, isUp) ;
     } catch (Exception e) {
       log.error("\nFail to vote answer\n", e);
-    }finally {sProvider.close() ;}
+    }
   }
   
   public void voteQuestion(String questionPath, String userName, int number) throws Exception {
-  	SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+  	SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = jcrData_.getFAQServiceHome(sProvider).getNode(questionPath) ;
       MultiLanguages.voteQuestion(questionNode, userName, number) ;
     } catch (Exception e) {
       log.error("\nFail to vote question\n", e);
-    }finally {sProvider.close() ;}
+    }
   }
   
   public void unVoteQuestion(String questionPath, String userName) throws Exception {
-  	SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+  	SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = jcrData_.getFAQServiceHome(sProvider).getNode(questionPath) ;
       MultiLanguages.unVoteQuestion(questionNode, userName);
     } catch (Exception e) {
       log.error("\nFail to unvote question\n", e);
-    }finally {sProvider.close() ;}
+    }
   } 	
   
   public String[] getModeratorsOf(String path) throws Exception{
Index: eXoApplication/faq/service/src/main/java/org/exoplatform/faq/service/impl/JCRDataStorage.java
===================================================================
--- eXoApplication/faq/service/src/main/java/org/exoplatform/faq/service/impl/JCRDataStorage.java	(revision 76510)
+++ eXoApplication/faq/service/src/main/java/org/exoplatform/faq/service/impl/JCRDataStorage.java	(working copy)
@@ -82,6 +82,7 @@
 import org.exoplatform.faq.service.SubCategoryInfo;
 import org.exoplatform.faq.service.Utils;
 import org.exoplatform.faq.service.Watch;
+import org.exoplatform.ks.common.CommonUtils;
 import org.exoplatform.ks.common.EmailNotifyPlugin;
 import org.exoplatform.ks.common.NotifyInfo;
 import org.exoplatform.ks.common.UserHelper;
@@ -172,7 +173,7 @@
     if (name == null) {
       name = ConversationState.getCurrent().getIdentity().getUserId();
     }
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;		
+    SessionProvider sProvider = CommonUtils.createSystemProvider();		
     try {
       Node cateHomeNode = getCategoryHome(sProvider, null);
       for(int i = 0; i < rulesPlugins_.size(); ++i) {
@@ -185,7 +186,7 @@
       }
     } catch (Exception e) {
       log.debug("Check user whether is admin: ", e);
-    } finally { sProvider.close() ;}
+    }
     return false ;
   }
 
@@ -209,7 +210,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getUserSetting(java.lang.String, org.exoplatform.faq.service.FAQSetting)
    */
   public void getUserSetting(String userName, FAQSetting faqSetting) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node userSettingHome = getUserSettingHome(sProvider) ;
       Node userSettingNode = userSettingHome.getNode(userName) ;
@@ -218,14 +219,14 @@
       if(userSettingNode.hasProperty("exo:sortQuestionByVote")) faqSetting.setSortQuestionByVote(userSettingNode.getProperty("exo:sortQuestionByVote").getValue().getBoolean());
     }catch (Exception e) {
       saveFAQSetting(faqSetting, userName);
-    }finally { sProvider.close() ;}		
+    }
   }
 
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#saveFAQSetting(org.exoplatform.faq.service.FAQSetting, java.lang.String)
    */
   public void saveFAQSetting(FAQSetting faqSetting,String userName) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{			
       Node userSettingNode = getUserSettingHome(sProvider).getNode(userName);
       userSettingNode.setProperty("exo:ordeBy", faqSetting.getOrderBy());
@@ -238,14 +239,14 @@
       userSettingNode.setProperty("exo:ordeType", faqSetting.getOrderType());
       userSettingNode.setProperty("exo:sortQuestionByVote", faqSetting.isSortQuestionByVote());
       userSettingNode.getSession().save() ;
-    }finally { sProvider.close() ;}		
+    }
   }
 
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#getUserAvatar(java.lang.String)
    */
   public FileAttachment getUserAvatar(String userName) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node node = getKSUserAvatarHomeNode(sProvider).getNode(userName);
       if(node.isNodeType("nt:file")) {
@@ -265,7 +266,7 @@
       return null;
     }catch(Exception e){
       log.error("Failed to get user avatar", e);
-    }finally { sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -273,7 +274,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#saveUserAvatar(java.lang.String, org.exoplatform.faq.service.FileAttachment)
    */
   public void saveUserAvatar(String userId, FileAttachment fileAttachment) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node ksAvatarHomeNode = getKSUserAvatarHomeNode(sProvider);
       Node avatarNode ;
@@ -290,14 +291,14 @@
       else ksAvatarHomeNode.save();
     }catch (Exception e) {
       log.error("Failed to save user avatar: ", e);
-    }finally {sProvider.close() ;}		
+    }	
   }
 
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#setDefaultAvatar(java.lang.String)
    */
   public void setDefaultAvatar(String userName)throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node avatarHome = getKSUserAvatarHomeNode(sProvider);
       if(avatarHome.hasNode(userName)){
@@ -309,7 +310,7 @@
       }
     }catch (Exception e) {
       log.error("Failed to set default avatar: ", e);
-    }finally { sProvider.close() ;}		
+    }
   }
 
 
@@ -318,14 +319,12 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getQuestionsIterator()
    */
   public NodeIterator getQuestionsIterator() throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider();
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node faqHome = getFAQServiceHome(sProvider);
 			return getQuestionsIterator(faqHome, "", true);
 		} catch (Exception e) {
 			log.error("Failed to get question iterator: ", e);
-		} finally {
-			sProvider.close();
 		}
 		return null;
 	}
@@ -389,7 +388,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#initRootCategory()
    */
   public boolean initRootCategory() throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node faqServiceHome = getFAQServiceHome(sProvider) ;
       if (faqServiceHome.hasNode(Utils.CATEGORY_HOME)) {
@@ -406,7 +405,7 @@
     }catch (Exception e) {
       log.error("Could not initialize root category", e);
       return false;
-    }finally {sProvider.close() ; }
+    }
 
   }
 
@@ -416,7 +415,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getTemplate()
    */
   public byte[] getTemplate() throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node templateHome = getTemplateHome(sProvider);
       Node fileNode = templateHome.getNode(Utils.UI_FAQ_VIEWER);
@@ -430,8 +429,6 @@
       }
     } catch (Exception e) {
       log.error("Failed to get template", e);
-    } finally {
-      sProvider.close();
     }
     return null;
   }
@@ -440,7 +437,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#saveTemplate(java.lang.String)
    */
   public void saveTemplate(String str) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node templateHome = getTemplateHome(sProvider);
       Node fileNode ;
@@ -468,8 +465,6 @@
       }
     } catch (Exception e) {
       log.error("Failed to save template: ", e);
-    } finally {
-      sProvider.close();
     }
   }
 
@@ -604,7 +599,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getQuestionLanguages(java.lang.String)
    */
   public List<QuestionLanguage> getQuestionLanguages(String questionId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     List<QuestionLanguage> listQuestionLanguage = new ArrayList<QuestionLanguage>() ;
     try {
       Node questionNode = getFAQServiceHome(sProvider).getNode(questionId) ;
@@ -622,7 +617,7 @@
       }
     }catch (Exception e){
       log.error("Failed to get question language: ", e);
-    } finally { sProvider.close() ;}		
+    }
     return listQuestionLanguage ;
   }
 
@@ -644,7 +639,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#deleteAnswer(java.lang.String, java.lang.String)
    */
   public void deleteAnswer(String questionId, String answerId) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = getFAQServiceHome(sProvider).getNode(questionId);
       Node answerNode = questionNode.getNode(Utils.ANSWER_HOME).getNode(answerId);
@@ -652,14 +647,14 @@
       questionNode.save();
     }catch (Exception e) {
       log.error("Failed to delete a answer: ", e);
-    }finally {sProvider.close() ;}
+    }
   }
 
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#deleteComment(java.lang.String, java.lang.String)
    */
   public void deleteComment(String questionId, String commentId) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = getFAQServiceHome(sProvider).getNode(questionId);
       Node commnetNode = questionNode.getNode(Utils.COMMENT_HOME).getNode(commentId);
@@ -667,7 +662,7 @@
       questionNode.save();
     }catch (Exception e) {
       log.error("Failed to delete a commnent: ", e);
-    }finally { sProvider.close() ;}
+    }
   }
 
   private Answer[] getAnswers(Node questionNode) throws Exception{
@@ -715,7 +710,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getPageListAnswer(java.lang.String, java.lang.Boolean)
    */
   public JCRPageList getPageListAnswer(String questionId, Boolean isSortByVote) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node answerHome = getFAQServiceHome(sProvider).getNode(questionId + "/" + Utils.ANSWER_HOME);
       QueryManager qm = answerHome.getSession().getWorkspace().getQueryManager();
@@ -731,7 +726,7 @@
     } catch (Exception e) {
       log.error("Failed to get page list answers", e);
       return null;
-    } finally { sProvider.close() ;}
+    }
   }
 
 
@@ -747,7 +742,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#saveAnswer(java.lang.String, org.exoplatform.faq.service.Answer[])
    */
   public void saveAnswer(String questionId, Answer[] answers) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node quesNode = getFAQServiceHome(sProvider).getNode(questionId);
       if(!quesNode.isNodeType("mix:faqi18n")) {
@@ -792,7 +787,7 @@
       quesNode.save() ;
     }catch (Exception e) {
       log.error("Failed to save answer: ", e);
-    }finally { sProvider.close() ;}
+    }
   }
 
   private void saveAnswer(Answer answer, Node answerHome, String questionId, String categoryId) throws Exception {
@@ -840,7 +835,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#saveComment(java.lang.String, org.exoplatform.faq.service.Comment, boolean)
    */
   public void saveComment(String questionId, Comment comment, boolean isNew) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node quesNode = getFAQServiceHome(sProvider).getNode(questionId);
       if(!quesNode.isNodeType("mix:faqi18n")) {
@@ -889,14 +884,14 @@
       else quesNode.save();
     }catch(Exception e) {
       log.error("Failed to save comment: ", e);
-    }finally { sProvider.close() ;}
+    }
   }
 
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#saveAnswerQuestionLang(java.lang.String, org.exoplatform.faq.service.Answer, java.lang.String, boolean)
    */
   public void saveAnswerQuestionLang(String questionId, Answer answer, String language, boolean isNew) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node quesNode = getFAQServiceHome(sProvider).getNode(questionId);
       Node answerHome = null;
@@ -926,7 +921,7 @@
       answerNode.setProperty("exo:usersVoteAnswer", answer.getUsersVoteAnswer()) ;
     }catch (Exception e) {
       log.error("Failed to save answer question language: ", e);
-    }finally { sProvider.close() ;}		
+    }
   }
 
   /*public void saveCommentQuestionLang(String questionId, Comment comment, String language, boolean isNew) throws Exception{
@@ -964,13 +959,13 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getAnswerById(java.lang.String, java.lang.String)
    */
   public Answer getAnswerById(String questionId, String answerid) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node answerNode = getFAQServiceHome(sProvider).getNode(questionId).getNode(Utils.ANSWER_HOME).getNode(answerid);
       return getAnswerByNode(answerNode);
     } catch (Exception e){
       log.error("Failed to get answer by id.", e);
-    }finally { sProvider.close() ;}
+    }
     return null;	
   }
 
@@ -1003,7 +998,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getPageListComment(java.lang.String)
    */
   public JCRPageList getPageListComment(String questionId) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node commentHome = getFAQServiceHome(sProvider).getNode(questionId + "/" + Utils.COMMENT_HOME) ;
       QueryManager qm = commentHome.getSession().getWorkspace().getQueryManager();
@@ -1016,7 +1011,7 @@
     } catch (Exception e) {
       log.error("Failed to get page list comments", e);
       return null;
-    } finally { sProvider.close() ; }
+    }
   }
 
   private Comment getCommentByNode(Node commentNode) throws Exception {
@@ -1034,14 +1029,14 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getCommentById(java.lang.String, java.lang.String)
    */
   public Comment getCommentById(String questionId, String commentId) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node commentNode =	getFAQServiceHome(sProvider).getNode(questionId + "/" + Utils.COMMENT_HOME + "/" + commentId);
       return getCommentByNode(commentNode);
     } catch (Exception e){
       log.error("Failed to get comment by id: "+commentId, e);
       return null;
-    } finally { sProvider.close() ;}
+    }
   }
 
   private Node getLanguageNodeByLanguage(Node questionNode, String languge) throws Exception{
@@ -1142,7 +1137,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#saveQuestion(org.exoplatform.faq.service.Question, boolean, org.exoplatform.faq.service.FAQSetting)
    */
   public Node saveQuestion(Question question, boolean isAddNew, FAQSetting faqSetting) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;		 
+    SessionProvider sProvider = CommonUtils.createSystemProvider();	 
     try {
       Node questionNode;
       Node questionHome ;
@@ -1175,7 +1170,7 @@
       return questionNode;
     }catch (Exception e) {
       log.error("Failed to save question ", e);
-    }finally {sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -1184,7 +1179,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#removeQuestion(java.lang.String)
    */
   public void removeQuestion(String questionId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = getFAQServiceHome(sProvider).getNode(questionId);
       Node questionHome = questionNode.getParent() ;
@@ -1192,7 +1187,7 @@
       questionHome.save();
     }catch (Exception e) {
       log.error("Fail ro remove question: ",e);
-    } finally { sProvider.close() ;}
+    }
   }
 
   /* (non-Javadoc)
@@ -1300,7 +1295,7 @@
 
   private List<String> getRetrictedCategories(String userId, List<String> usermemberships) throws Exception{
     List<String> categoryList = new ArrayList<String>();
-    SessionProvider sessionProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sessionProvider = CommonUtils.createSystemProvider();
     try{
       Node faqHome = getFAQServiceHome(sessionProvider);
       StringBuffer queryString = new StringBuffer("/jcr:root").append(faqHome.getPath()). 
@@ -1335,7 +1330,7 @@
       }
     }catch(Exception e) {
       log.error("Failed to get restricte category: ", e);
-    }finally{ sessionProvider.close() ;}		
+    }
     return categoryList;
   }
 
@@ -1343,7 +1338,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getAllQuestions()
    */
   public QuestionPageList getAllQuestions() throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider, null) ;
       QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -1361,7 +1356,7 @@
       return pageList ;
     }catch (Exception e) {
       log.error("Failed to get all questions: ", e);
-    } finally { sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -1370,7 +1365,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getQuestionsNotYetAnswer(java.lang.String, boolean)
    */
   public QuestionPageList getQuestionsNotYetAnswer(String categoryId, boolean isApproved) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider, null) ;
       QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -1409,14 +1404,14 @@
       return pageList ;
     }catch (Exception e) {
       log.error("Get question not yet answer failed: ", e);
-    }finally { sProvider.close() ;}
+    }
     return null ;
   }
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#getPendingQuestionsByCategory(java.lang.String, org.exoplatform.faq.service.FAQSetting)
    */
   public QuestionPageList getPendingQuestionsByCategory(String categoryId, FAQSetting faqSetting) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider, null) ;
       QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -1448,7 +1443,7 @@
       return pageList ;
     }catch (Exception e) {
       log.error("Get pedding question through category failed: ", e);
-    }finally {sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -1456,7 +1451,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getQuestionsByCatetory(java.lang.String, org.exoplatform.faq.service.FAQSetting)
    */
   public QuestionPageList getQuestionsByCatetory(String categoryId, FAQSetting faqSetting) throws Exception {
-    SessionProvider sProvider =	SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider =	CommonUtils.createSystemProvider();
     try {
       String id ;
       Node categoryNode ;
@@ -1506,7 +1501,7 @@
       return pageList ;
     }catch (Exception e) {
       log.debug("Getting question through category failed: ", e);
-    }finally { sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -1514,7 +1509,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getAllQuestionsByCatetory(java.lang.String, org.exoplatform.faq.service.FAQSetting)
    */
   public QuestionPageList getAllQuestionsByCatetory(String categoryId, FAQSetting faqSetting) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider, null) ;
       QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -1550,7 +1545,7 @@
       return pageList ;
     }catch (Exception e) {
       log.debug("Failed to get all question through category: ", e);
-    }finally { sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -1558,7 +1553,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getQuestionsByListCatetory(java.util.List, boolean)
    */
   public QuestionPageList getQuestionsByListCatetory(List<String> listCategoryId, boolean isNotYetAnswer) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider, null) ;
 
@@ -1582,7 +1577,7 @@
       return pageList ;
     } catch ( Exception e) {
       log.debug("Failed get questions through list of category: ", e);
-    }finally { sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -1590,7 +1585,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getQuickQuestionsByListCatetory(java.util.List, boolean)
    */
   public List<Question> getQuickQuestionsByListCatetory(List<String> listCategoryId, boolean isNotYetAnswer) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     List<Question> questions = new ArrayList<Question> () ;
     try {
       Node categoryHome = getCategoryHome(sProvider, null) ;
@@ -1612,7 +1607,7 @@
       }
     } catch ( Exception e) {
       log.debug("Getting quick questions through list of category failed: ", e);
-    }finally { sProvider.close() ;}
+    }
     return questions ;
   }
 
@@ -1630,7 +1625,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getCategoryPathOfQuestion(java.lang.String)
    */
   public String getCategoryPathOfQuestion(String questionPath) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     String path = "";
     Node faqHome = null;
     try {
@@ -1649,7 +1644,7 @@
       }
     }catch( Exception e) {
       log.debug("Getting category path of the question failed: ", e);
-    }finally { sProvider.close() ;}		
+    }
     return path;
   }
 
@@ -1658,7 +1653,7 @@
    */
   public void moveQuestions(List<String> questions, String destCategoryId, String questionLink, FAQSetting faqSetting) throws Exception {
 
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node faqHome = getFAQServiceHome(sProvider) ;
       String homePath = faqHome.getPath() ;
@@ -1699,7 +1694,7 @@
       }			
     }catch (Exception e) {
       log.error("Failed to remove question: ", e);
-    }finally { sProvider.close() ;}
+    }
 
   } 
 
@@ -1777,7 +1772,7 @@
    */
   public void changeStatusCategoryView(List<String> listCateIds) throws Exception{
     if(listCateIds == null || listCateIds.size() < 1) return;
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node faqHome = getFAQServiceHome(sProvider);
       Node cat ;
@@ -1788,7 +1783,7 @@
       faqHome.save();
     }catch (Exception e) {
       log.error("Changing status category view failed: ", e);
-    }finally { sProvider.close() ;}		
+    }
   }
 
 
@@ -1796,7 +1791,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getMaxindexCategory(java.lang.String)
    */
   public long getMaxindexCategory(String parentId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     long max = 0 ;
     try {
       NodeIterator iter = getFAQServiceHome(sProvider).getNode((parentId == null)?Utils.CATEGORY_HOME:parentId).getNodes();
@@ -1806,7 +1801,7 @@
       }
     }catch (Exception e) {
       log.error("Failed to get max index category", e);
-    }finally { sProvider.close() ;}
+    }
     return max ;
   }
 
@@ -1934,7 +1929,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#saveCategory(java.lang.String, org.exoplatform.faq.service.Category, boolean)
    */
   public void saveCategory(String parentId, Category cat, boolean isAddNew) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node newCategory ;
       if(isAddNew) {
@@ -1960,7 +1955,7 @@
       }			
     }catch (Exception e) {
       log.error("Failed to save category: ", e);
-    }finally { sProvider.close() ;}
+    }
 
   }
 
@@ -1990,28 +1985,26 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#listingCategoryTree()
    */
   public List<Cate> listingCategoryTree() throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-    try {
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
       Node cateHome = getCategoryHome(sProvider, null) ;
       int i = 1 ;
       List<Cate> cateList = new ArrayList<Cate>() ;		
       cateList.addAll(listingSubTree(cateHome, i)) ;
       return cateList	;
-    }finally { sProvider.close() ;}	
   }
 
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#removeCategory(java.lang.String)
    */
   public void removeCategory(String categoryId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node faqHome = getFAQServiceHome(sProvider) ;
       faqHome.getNode(categoryId).remove() ;
       faqHome.save() ;
     }catch (Exception e) {
       log.error("Can not remove category has id: " + categoryId);
-    } finally { sProvider.close() ;}		
+    }	
   }
 
   private Category getCategory(Node categoryNode) throws Exception {
@@ -2037,12 +2030,12 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getCategoryById(java.lang.String)
    */
   public Category getCategoryById(String categoryId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       return getCategory(getCategoryNodeById(sProvider, categoryId)) ;
     }catch (Exception e) {
       log.debug("Category not found " + categoryId);
-    }finally { sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -2050,7 +2043,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#findCategoriesByName(java.lang.String)
    */
   public List<Category> findCategoriesByName(String categoryName) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider, null) ;
       QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -2067,7 +2060,7 @@
       return result ;
     }catch(Exception e) {
       log.error("Could not retrieve categories by name " + categoryName, e);
-    }finally { sProvider.close() ;}
+    }
     return null ;	 
   }
 
@@ -2076,7 +2069,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getListCateIdByModerator(java.lang.String)
    */
   public List<String> getListCateIdByModerator(String user) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider, null) ;
       QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -2098,7 +2091,7 @@
       return listCateId ;
     }catch(Exception e) {
       log.error("Failed to get list of CateID through Moderator: ", e);
-    }finally { sProvider.close() ;}
+    }
     return null ;		
   }
 
@@ -2106,7 +2099,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getAllCategories()
    */
   public List<Category> getAllCategories() throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider, null) ;
       QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -2121,7 +2114,7 @@
       return catList ;
     }catch (Exception e) {
       log.error("Getting all category failed: ", e);
-    }finally { sProvider.close() ;}
+    }
     return null ;
 
   }
@@ -2130,7 +2123,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#existingCategories()
    */
   public long existingCategories() throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider, null) ;
       QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -2140,7 +2133,7 @@
       result.getNodes().getSize() ;			
     }catch (Exception e) {
       log.error("Failed to check existing categories", e);
-    }finally { sProvider.close() ;}
+    }
     return 0 ;		
   }
 
@@ -2148,12 +2141,12 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getCategoryNodeById(java.lang.String)
    */
   public Node getCategoryNodeById(String categoryId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       return getCategoryNodeById(sProvider, categoryId);
     }catch (Exception e) {
       log.error("Getting node failed: ", e);
-    } finally {sProvider.close() ;} 
+    }
     return null ;
   }
 
@@ -2179,7 +2172,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getSubCategories(java.lang.String, org.exoplatform.faq.service.FAQSetting, boolean, java.util.List)
    */
   public List<Category> getSubCategories(String categoryId, FAQSetting faqSetting, boolean isGetAll, List<String> limitedUsers) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     List<Category> catList = new ArrayList<Category>() ;
     try {			
       Node parentCategory ;			
@@ -2215,7 +2208,7 @@
       } 
     }catch (Exception e) {
       throw e;
-    }finally {sProvider.close();}		
+    }
     return catList ;
   }
 
@@ -2223,7 +2216,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getCategoryInfo(java.lang.String, org.exoplatform.faq.service.FAQSetting)
    */
   public long[] getCategoryInfo( String categoryId, FAQSetting faqSetting) throws Exception	{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     long[] cateInfo = new long[]{0, 0, 0, 0};// categories, all, open, pending
     try {
       Node parentCategory ;
@@ -2264,7 +2257,7 @@
       }
     }catch(Exception e) {
       log.error("Failed to get category info: ", e);
-    }finally {sProvider.close() ;}
+    }
     return cateInfo ;
   }
 
@@ -2280,7 +2273,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#moveCategory(java.lang.String, java.lang.String)
    */
   public void moveCategory(String categoryId, String destCategoryId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node faqHome = getFAQServiceHome(sProvider) ;
       Node srcNode = faqHome.getNode(categoryId) ;
@@ -2298,14 +2291,13 @@
     } catch (Exception e) {
       if(log.isDebugEnabled()) log.debug(e.getMessage());
     }
-    finally { sProvider.close() ;}		
   }
 
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#addWatchCategory(java.lang.String, org.exoplatform.faq.service.Watch)
    */
   public void addWatchCategory(String id, Watch watch)throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node faqHome = getFAQServiceHome (sProvider) ;
       Map<String, String> watchs = new HashMap<String, String> () ;
@@ -2329,7 +2321,7 @@
       watchingNode.save() ;
     }catch (Exception e) {
       log.error("Failed to add watch category: " , e);
-    } finally {sProvider.close() ;} 
+    }
   }
 
   //TODO Going to remove
@@ -2337,7 +2329,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getListMailInWatch(java.lang.String)
    */
   public QuestionPageList getListMailInWatch(String categoryId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider, null) ;	
       QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -2349,7 +2341,7 @@
       return pageList;
     }catch(Exception e) {
       log.error("Failed to get list of mail watch: ", e);
-    }finally {sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -2357,7 +2349,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getWatchByCategory(java.lang.String)
    */
   public List<Watch> getWatchByCategory(String categoryId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     List<Watch> listWatches = new ArrayList<Watch>();
     try {
       Node category = getFAQServiceHome(sProvider).getNode(categoryId) ;
@@ -2377,7 +2369,7 @@
       return listWatches;
     }catch(Exception e) {
       log.error("Failed to get watch through category: ",e);
-    }finally {sProvider.close() ;}
+    }
     return listWatches ;
   }
 
@@ -2385,13 +2377,13 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#hasWatch(java.lang.String)
    */
   public boolean hasWatch(String categoryPath) {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node cat = getFAQServiceHome(sProvider).getNode(categoryPath) ;
       if(new PropertyReader(cat).strings("exo:userWatching", new String[]{}).length > 0) return true ;
     }catch (Exception e) {
       log.error("Failed to check has watch", e);
-    }finally { sProvider.close() ;}
+    }
     return false ;
   }
 
@@ -2399,7 +2391,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#addWatchQuestion(java.lang.String, org.exoplatform.faq.service.Watch, boolean)
    */
   public void addWatchQuestion(String questionId, Watch watch, boolean isNew) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     Map<String, String> watchMap = new HashMap<String, String>() ;
     try {
       Node questionNode = getFAQServiceHome(sProvider).getNode(questionId);
@@ -2423,7 +2415,7 @@
       //questionHome.save();
     }catch (Exception e) {
       log.error("Failed to add a watch question: ", e );
-    }finally { sProvider.close () ;} 
+    }
 
   }
 
@@ -2431,7 +2423,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getWatchByQuestion(java.lang.String)
    */
   public List<Watch> getWatchByQuestion(String questionId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     List<Watch> listWatches = new ArrayList<Watch>();
     try {
       Node category = getFAQServiceHome(sProvider).getNode(questionId) ;
@@ -2452,7 +2444,7 @@
       }
     }catch(Exception e) {
       log.error("Failed to get watch through question: ", e);
-    }finally {sProvider.close() ;}
+    }
     return listWatches ;
   }
 
@@ -2460,7 +2452,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getWatchedCategoryByUser(java.lang.String)
    */
   public QuestionPageList getWatchedCategoryByUser(String userId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider, null);
       QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -2473,7 +2465,7 @@
       return pageList ;
     }catch ( Exception e) {
       log.error("Failed to get watched category through user: ", e);
-    }finally { sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -2481,7 +2473,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#isUserWatched(java.lang.String, java.lang.String)
    */
   public boolean isUserWatched(String userId, String cateId) {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node faqHome = getFAQServiceHome(sProvider);
       Node cate = faqHome.getNode(cateId) ;
@@ -2491,7 +2483,7 @@
       }
     }catch (Exception e) {
       log.error("Failed to check user watched", e);
-    }finally { sProvider.close() ;}
+    }
     return false;
   }
 
@@ -2499,7 +2491,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getWatchedSubCategory(java.lang.String, java.lang.String)
    */
   public List<String> getWatchedSubCategory(String userId, String cateId) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     List<String> watchedSub = new ArrayList<String> () ;
     try {
       Node faqHome = getFAQServiceHome(sProvider);
@@ -2515,7 +2507,7 @@
       }
     }catch (Exception e) {
       log.error("Getting watched sub category failed: ", e);
-    }finally { sProvider.close() ;}
+    }
     return watchedSub ;
   }
 
@@ -2523,7 +2515,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getListQuestionsWatch(org.exoplatform.faq.service.FAQSetting, java.lang.String)
    */
   public QuestionPageList getListQuestionsWatch(FAQSetting faqSetting, String currentUser) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider, null) ;
       QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -2556,7 +2548,7 @@
       return pageList ;
     }catch (Exception e) {
       log.error("Failed to get list of question watch: ", e);
-    }finally { sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -2565,7 +2557,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#deleteCategoryWatch(java.lang.String, java.lang.String)
    */
   public void deleteCategoryWatch(String categoryId, String user) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node category = getFAQServiceHome(sProvider).getNode(categoryId) ;
       Map<String, String> emailMap = new HashMap<String, String>() ;
@@ -2580,14 +2572,14 @@
       category.save() ;		
     }catch (Exception e) {
       log.error("Failed to deleted category watch", e);
-    }finally { sProvider.close() ;}
+    }
   }
 
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#unWatchCategory(java.lang.String, java.lang.String)
    */
   public void unWatchCategory(String categoryId, String user) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node category = getFAQServiceHome(sProvider).getNode(categoryId) ;
       Map<String, String> userMap = new HashMap<String, String>() ;
@@ -2602,14 +2594,14 @@
       category.save() ;		
     }catch (Exception e) {
       log.error("Failed to unWatch category", e);
-    }finally { sProvider.close() ;}
+    }
   }
 
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#unWatchQuestion(java.lang.String, java.lang.String)
    */
   public void unWatchQuestion(String questionId, String user) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node question = getFAQServiceHome(sProvider).getNode(questionId) ;
       Map<String, String> userMap = new HashMap<String, String>() ;
@@ -2624,14 +2616,14 @@
       question.save() ;
     }catch (Exception e) {
       log.error("Unwatching question failed: ", e);
-    }finally { sProvider.close() ;}		
+    }
   }
 
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#getSearchResults(org.exoplatform.faq.service.FAQEventQuery)
    */
   public List<ObjectSearchResult> getSearchResults(FAQEventQuery eventQuery) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
 
     eventQuery.setViewingCategories(getViewableCategoryIds(sProvider)) ;
     List<String> retrictedCategoryList = new ArrayList<String>() ;
@@ -2978,7 +2970,7 @@
       }			
     } catch (Exception e) {
       throw e;
-    } finally {sProvider.close() ;}
+    }
     return new ArrayList<ObjectSearchResult> () ;
   }
 
@@ -3055,7 +3047,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getCategoryPath(java.lang.String)
    */
   public List<String> getCategoryPath(String categoryId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     List<String> breadcums = new ArrayList<String>() ;
     try {
       Node category = getFAQServiceHome(sProvider).getNode(categoryId) ;
@@ -3065,7 +3057,7 @@
       }
     }catch(Exception e) {
       log.error("Failed to get category: ", e);
-    }finally { sProvider.close() ;}		
+    }
     return breadcums;
   }
 
@@ -3073,7 +3065,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getParentCategoriesName(java.lang.String)
    */
   public String getParentCategoriesName(String path) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     StringBuilder names = new StringBuilder();
     List<String> list = new ArrayList<String>();
     try {
@@ -3092,7 +3084,7 @@
       }
     }catch (Exception e) {
       log.error("Failed to get parent categories name", e);
-    }finally { sProvider.close() ;}		
+    }
     return names.toString();
   }
 
@@ -3128,7 +3120,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#swapCategories(java.lang.String, java.lang.String)
    */
   public void swapCategories(String cateId1, String cateId2) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider();
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       String[] strs = Utils.splitForFAQ(cateId2);
       boolean isTop = (strs.length > 1 && strs[1].trim().length() > 0);
@@ -3155,23 +3147,21 @@
       }
     } catch (Exception e) {
       log.error("Failed to swap categories", e);
-    } finally {
-      sProvider.close();
-    }
+    } 
   }
 
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#saveTopicIdDiscussQuestion(java.lang.String, java.lang.String)
    */
   public void saveTopicIdDiscussQuestion(String questionId, String topicId) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node questionNode = getFAQServiceHome(sProvider).getNode(questionId);
       questionNode.setProperty("exo:topicIdDiscuss", topicId);
       questionNode.save() ;
     } catch (Exception e) {
       log.error("Failed to save topic discuss question: ", e);
-    }finally { sProvider.close() ;}
+    }
   }
 
   /* (non-Javadoc)
@@ -3217,7 +3207,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#importData(java.lang.String, java.io.InputStream, boolean)
    */
   public boolean importData(String parentId, InputStream inputStream, boolean isZip) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
     	List<String> patchNodeImport = new ArrayList<String>();
     	Node categoryNode = getFAQServiceHome(sProvider).getNode(parentId);
@@ -3270,7 +3260,7 @@
     }catch(Exception e) {
       log.error("Failed to import data in category " + parentId, e);
       return false ;
-    }finally{ sProvider.close() ;}	
+    }
     return true ;
   }
   //
@@ -3316,17 +3306,15 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#isExisting(java.lang.String)
    */
   public boolean isExisting(String path) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-    try{
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     	return getFAQServiceHome(sProvider).hasNode(path);
-    } finally { sProvider.close() ;}
   }
 
   /* (non-Javadoc)
    * @see org.exoplatform.faq.service.impl.DataStorage#getCategoryPathOf(java.lang.String)
    */
   public String getCategoryPathOf(String id) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node node = getFAQServiceHome(sProvider).getNode(id) ;
       String path;	
@@ -3336,7 +3324,7 @@
       return path.substring(path.indexOf(Utils.CATEGORY_HOME)) ;
     }catch (Exception e) {			
       log.error("Failed to get category of path: "+id, e);
-    }finally { sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -3344,7 +3332,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#isModerateAnswer(java.lang.String)
    */
   public boolean isModerateAnswer(String id) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node node = getFAQServiceHome(sProvider).getNode(id) ;
       if(node.isNodeType("exo:faqQuestion")) node = node.getParent().getParent() ;
@@ -3353,7 +3341,7 @@
       return false;
     }catch (Exception e) {
       log.error("Failed to check moderate answer", e);
-    }finally { sProvider.close() ;}
+    }
     return false ;
   }
 
@@ -3361,7 +3349,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#isModerateQuestion(java.lang.String)
    */
   public boolean isModerateQuestion(String id) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node node = getFAQServiceHome(sProvider).getNode(id) ;
       if(node.isNodeType("exo:faqQuestion")) node = node.getParent().getParent() ;
@@ -3370,7 +3358,7 @@
       return false;
     } catch (Exception e) {
       log.error("Failed to moderate question", e);
-    }finally { sProvider.close() ;}
+    }
     return false ;
   }
 
@@ -3378,7 +3366,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#isViewAuthorInfo(java.lang.String)
    */
   public boolean isViewAuthorInfo(String id) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node node ;
       if(id == null) node = getCategoryHome(sProvider, null) ;
@@ -3387,12 +3375,12 @@
       return new PropertyReader(node).bool("exo:viewAuthorInfor", false);
     }catch (Exception e) {
       log.error("Failed to check view author infor", e);
-    }finally { sProvider.close() ;}
+    }
     return false ;
   }
 
   public boolean isCategoryModerator(String categoryId, String user) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     boolean isCalMod = false;
     try{
       List<String> userGroups = UserHelper.getAllGroupAndMembershipOfUser(user);
@@ -3404,8 +3392,7 @@
         isCalMod =	Utils.hasPermission(userGroups, values);
     }catch(Exception e) {
       log.error("Cheking whether category moderator failed: ", e); 
-    }finally { sProvider.close() ;}
-
+    }
     return isCalMod ;
   }
 
@@ -3413,7 +3400,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#isCategoryExist(java.lang.String, java.lang.String)
    */
   public boolean isCategoryExist(String name, String path) {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node category = getFAQServiceHome(sProvider).getNode(path) ;
       NodeIterator iter = category.getNodes() ;
@@ -3427,8 +3414,6 @@
       }			
     }catch(Exception e) {
       log.error("Cheking whether catagory is exist: ", e);
-    }finally{
-      sProvider.close() ;
     }
     return false ;
   }
@@ -3451,7 +3436,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getQuestionNodeById(java.lang.String)
    */
   public Node getQuestionNodeById(String path) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node serviceHome = getFAQServiceHome(sProvider) ;
       try {
@@ -3468,7 +3453,7 @@
       }
     }catch (Exception e) {
       log.error("Failed to get question node by path:"+path, e);
-    }finally {sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -3476,7 +3461,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getModeratorsOf(java.lang.String)
    */
   public String[] getModeratorsOf(String path) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node node = getFAQServiceHome(sProvider).getNode(path) ;
       if(node.isNodeType("exo:faqQuestion")) {
@@ -3486,7 +3471,7 @@
       }
     }catch (Exception e) {			
       log.error("Failed to get moderators of path: " + path, e);
-    }finally { sProvider.close() ;}
+    }
     return new String[]{} ;
   }
 
@@ -3494,14 +3479,14 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getCategoryNameOf(java.lang.String)
    */
   public String getCategoryNameOf(String categoryPath) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node node = getFAQServiceHome(sProvider).getNode(categoryPath) ;
       if(node.hasProperty("exo:name")) return node.getProperty("exo:name").getString() ;
       return node.getName() ;
     }catch (Exception e) {			
       log.error("Failed to get category name of path: " + categoryPath, e);
-    }finally { sProvider.close() ;}
+    }
     return null ;
   }
 
@@ -3509,7 +3494,7 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#getCategoryInfo(java.lang.String, java.util.List)
    */
   public CategoryInfo getCategoryInfo(String categoryPath, List<String> categoryIdScoped) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     CategoryInfo categoryInfo = new CategoryInfo() ;
     try {
       Node categoryNode = getFAQServiceHome(sProvider).getNode(categoryPath) ;
@@ -3558,7 +3543,7 @@
       }
     }catch(Exception e) {
       return null;
-    }finally{ sProvider.close() ;}
+    }
     return categoryInfo ;
   }
 
@@ -3582,7 +3567,7 @@
   }
 
   public void reCalculateInfoOfQuestion(String absPathOfProp) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider();
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Item item = null;
       Node quesNode = null;
@@ -3672,8 +3657,6 @@
       }
     } catch (Exception e) {
       log.error("Failed to re calculateInfo of question", e);
-    } finally {
-      sProvider.close();
     }
   }
 
@@ -3808,19 +3791,19 @@
    * @see org.exoplatform.faq.service.impl.DataStorage#updateQuestionRelatives(java.lang.String, java.lang.String[])
    */
   public void updateQuestionRelatives( String questionPath, String[] relatives) throws Exception{
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node question = getFAQServiceHome(sProvider).getNode(questionPath) ;
       question.setProperty("exo:relatives", relatives) ;
       question.save() ;
     }catch (Exception e) {
       log.error("Failed to update question relatives: ", e);
-    }finally {sProvider.close() ;}
+    }
   }
 
 
   public InputStream createAnswerRSS(String cateId) throws Exception {
-    SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try{
       Node cateNode = getCategoryNodeById(sProvider, cateId);
       List<SyndEntry> entries = new ArrayList<SyndEntry>();
@@ -3869,7 +3852,7 @@
       return new ByteArrayInputStream(s.getBytes());
     }catch (Exception e) {
       log.error("Failed to create answer RSS ", e);
-    }finally {sProvider.close() ;}
+    }
     return null;
   }
 
Index: eXoApplication/common/src/main/java/org/exoplatform/ks/common/CommonUtils.java
===================================================================
--- eXoApplication/common/src/main/java/org/exoplatform/ks/common/CommonUtils.java	(revision 0)
+++ eXoApplication/common/src/main/java/org/exoplatform/ks/common/CommonUtils.java	(revision 0)
@@ -0,0 +1,36 @@
+/*
+ * Copyright (C) 2003-2011 eXo Platform SAS.
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Affero General Public License
+ * as published by the Free Software Foundation; either version 3
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, see<http://www.gnu.org/licenses/>.
+ */
+package org.exoplatform.ks.common;
+
+import org.exoplatform.container.ExoContainerContext;
+import org.exoplatform.services.jcr.ext.app.SessionProviderService;
+import org.exoplatform.services.jcr.ext.common.SessionProvider;
+
+/**
+ * Created by The eXo Platform SAS
+ * Author : viet.nguyen
+ *          viet.nguyen@exoplatform.com
+ * Sep 7, 2011  
+ */
+public class CommonUtils {
+
+  public static SessionProvider createSystemProvider() {
+    SessionProviderService sessionProviderService = (SessionProviderService) ExoContainerContext.getCurrentContainer().getComponentInstanceOfType(SessionProviderService.class);
+    return sessionProviderService.getSystemSessionProvider(null);
+  }
+  
+}
Index: eXoApplication/forum/service/src/test/resources/conf/forum-configuration.xml
===================================================================
--- eXoApplication/forum/service/src/test/resources/conf/forum-configuration.xml	(revision 76510)
+++ eXoApplication/forum/service/src/test/resources/conf/forum-configuration.xml	(working copy)
@@ -4,6 +4,9 @@
   xmlns="http://www.exoplaform.org/xml/ns/kernel_1_0.xsd">
 
   <component>
+    <type>org.exoplatform.services.jcr.ext.app.ThreadLocalSessionProviderService</type>
+  </component>
+  <component>
       <type>org.exoplatform.services.rest.impl.RequestHandlerImpl</type>
    </component>
    <component>
Index: eXoApplication/forum/service/src/main/java/org/exoplatform/forum/service/impl/JCRDataStorage.java
===================================================================
--- eXoApplication/forum/service/src/main/java/org/exoplatform/forum/service/impl/JCRDataStorage.java	(revision 76510)
+++ eXoApplication/forum/service/src/main/java/org/exoplatform/forum/service/impl/JCRDataStorage.java	(working copy)
@@ -35,9 +35,9 @@
 import java.util.Iterator;
 import java.util.List;
 import java.util.Map;
+import java.util.Map.Entry;
 import java.util.Queue;
 import java.util.Set;
-import java.util.Map.Entry;
 import java.util.concurrent.ConcurrentLinkedQueue;
 import java.util.zip.ZipEntry;
 import java.util.zip.ZipOutputStream;
@@ -87,6 +87,8 @@
 import org.exoplatform.forum.service.Post;
 import org.exoplatform.forum.service.PruneSetting;
 import org.exoplatform.forum.service.SortSettings;
+import org.exoplatform.forum.service.SortSettings.Direction;
+import org.exoplatform.forum.service.SortSettings.SortField;
 import org.exoplatform.forum.service.Tag;
 import org.exoplatform.forum.service.Topic;
 import org.exoplatform.forum.service.TopicListAccess;
@@ -94,8 +96,6 @@
 import org.exoplatform.forum.service.UserProfile;
 import org.exoplatform.forum.service.Utils;
 import org.exoplatform.forum.service.Watch;
-import org.exoplatform.forum.service.SortSettings.Direction;
-import org.exoplatform.forum.service.SortSettings.SortField;
 import org.exoplatform.forum.service.conf.CategoryData;
 import org.exoplatform.forum.service.conf.CategoryEventListener;
 import org.exoplatform.forum.service.conf.ForumData;
@@ -104,15 +104,16 @@
 import org.exoplatform.forum.service.conf.SendMessageInfo;
 import org.exoplatform.forum.service.conf.StatisticEventListener;
 import org.exoplatform.forum.service.conf.TopicData;
+import org.exoplatform.ks.common.CommonUtils;
 import org.exoplatform.ks.common.UserHelper;
 import org.exoplatform.ks.common.conf.InitialRSSListener;
 import org.exoplatform.ks.common.conf.RoleRulesPlugin;
 import org.exoplatform.ks.common.jcr.JCRSessionManager;
 import org.exoplatform.ks.common.jcr.JCRTask;
 import org.exoplatform.ks.common.jcr.KSDataLocation;
+import org.exoplatform.ks.common.jcr.KSDataLocation.Locations;
 import org.exoplatform.ks.common.jcr.PropertyReader;
 import org.exoplatform.ks.common.jcr.SessionManager;
-import org.exoplatform.ks.common.jcr.KSDataLocation.Locations;
 import org.exoplatform.management.annotations.Managed;
 import org.exoplatform.management.annotations.ManagedDescription;
 import org.exoplatform.management.jmx.annotations.NameTemplate;
@@ -241,7 +242,7 @@
 	}
 	
 	public void addCalculateModeratorEventListener() throws Exception{
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node categoryHome = getCategoryHome(sProvider) ;
 		try{
 			NodeIterator iter = categoryHome.getNodes();
@@ -261,7 +262,7 @@
 			}
 		}catch(Exception e){
 			log.error("Failed to add calculate moderator event listener",e);
-		} finally{ sProvider.close() ;}
+		}
 	}
 	
 	protected void addModeratorCalculateListener(Node node) throws Exception{
@@ -278,14 +279,13 @@
 	}
 
 	public void addDeletedUserCalculateListener() throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node profileHome = getUserProfileHome(sProvider) ;
 		try{
 			if(profileHome.hasNode(Utils.USER_PROFILE_DELETED)) {
 				deletedUserCalculateListener(profileHome.getNode(Utils.USER_PROFILE_DELETED));
 			}
-		}catch(Exception e){ } 
-		finally{ sProvider.close() ;}
+		}catch(Exception e){ }
 		
 	}
 	
@@ -302,7 +302,7 @@
 	}
 	
 	public void initCategoryListener() {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		listeners.clear() ;
 		try{
 			Node categoryHome = getCategoryHome(sProvider) ;
@@ -326,14 +326,11 @@
 			
 		}catch(Exception e) {
 			log.error("Failed to init category listenner",e);
-		}finally{
-			sProvider.close() ;	
 		}
 	}
 	
 	public void initAutoPruneSchedules() throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-		try{
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 			Node categoryHNode = getCategoryHome(sProvider);
 			QueryManager qm = categoryHNode.getSession().getWorkspace().getQueryManager();
 			StringBuilder pathQuery = new StringBuilder();
@@ -344,7 +341,6 @@
 			while (iter.hasNext()) {
 				addOrRemoveSchedule(getPruneSetting(iter.nextNode())) ;
 			}
-		}finally { sProvider.close() ;}
 	}
 	
 	public boolean isAdminRole(String userName) throws Exception {
@@ -608,7 +604,7 @@
 	}
 	
 	public void saveForumAdministration(ForumAdministration forumAdministration) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node administrationHome = getAdminHome(sProvider);
 			Node forumAdminNode;
@@ -633,12 +629,11 @@
 			}
 		}catch(Exception e) {
 			log.error("Failed to save forum administration.",e);
-		}finally {sProvider.close() ;}		
+		}	
 	}
 
 	public ForumAdministration getForumAdministration() throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-		try{
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 			ForumAdministration forumAdministration = new ForumAdministration();
 			try {
 				Node forumAdminNode = getAdminHome(sProvider).getNode(Utils.FORUMADMINISTRATION);
@@ -658,32 +653,29 @@
 			} catch (PathNotFoundException e) {
 				return forumAdministration;
 			}
-		}finally{ sProvider.close() ;}		
 	}
 	
 	public SortSettings getForumSortSettings() throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider();
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumAdminNode = getAdminHome(sProvider).getNode(Utils.FORUMADMINISTRATION);
 			PropertyReader reader = new PropertyReader(forumAdminNode);
 			return new SortSettings(reader.string(EXO_FORUM_SORT_BY), reader.string(EXO_FORUM_SORT_BY_TYPE));
 		} catch (PathNotFoundException e) {
 			log.warn("Could not log forum sort order in forum administration node: " + e.getMessage());
-		} finally {
-			sProvider.close();
 		}
 		return new SortSettings(SortField.ORDER, Direction.ASC);
 	}
 
 	public SortSettings getTopicSortSettings() throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumAdminNode = getAdminHome(sProvider).getNode(Utils.FORUMADMINISTRATION);
 			PropertyReader reader = new PropertyReader(forumAdminNode);
 			return new SortSettings(reader.string(EXO_TOPIC_SORT_BY), reader.string(EXO_TOPIC_SORT_BY_TYPE));
 		} catch (Exception e) {
 			log.warn("Could not log topic sort order in forum administration node: " + e.getMessage());
-		}	finally{ sProvider.close() ;}		
+		}
 		return new SortSettings(SortField.LASTPOST, Direction.DESC);
 	}	
 
@@ -749,13 +741,11 @@
 			forumStatisticNode.save();
 		}catch (Exception e) {
 			log.error("Init default data is failed!!", e);
-		}finally {
-			sProvider.close();
 		}
 	}
 
 	public List<Category> getCategories() throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<Category> categories = new ArrayList<Category>();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
@@ -774,12 +764,12 @@
 		} catch(Exception e) {
 			log.warn("Can not get all categories.", e);
 			return categories ;
-		}finally { sProvider.close() ;}
+		}
 		
 	}
 
 	public Category getCategory(String categoryId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			return getCategory(getCategoryHome(sProvider).getNode(categoryId));
 		}
@@ -791,20 +781,20 @@
 		catch (Exception e) {
 			log.error(e.getMessage(),e);
 			return null;
-		}finally{ sProvider.close() ;} 
+		}
 	}
 	
 	public String[] getPermissionTopicByCategory(String categoryId, String type) throws Exception {
 		String[] canCreated = new String[]{" "};
 		type = "exo:"+type;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node cateNode = getCategoryHome(sProvider).getNode(categoryId);
 			if (cateNode.hasProperty(type))
 				canCreated = Utils.valuesToArray(cateNode.getProperty(type).getValues());
 		} catch (Exception e) {
 			log.error("Failed to get permission topic by category",e);
-		}finally{ sProvider.close() ;} 
+		}
 		return canCreated;
 	}
 
@@ -832,7 +822,7 @@
 	}
 
 	public void saveCategory(Category category, boolean isNew) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node catNode = null;
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
@@ -870,11 +860,11 @@
 		}catch(Exception e) {
 			log.error("Failed to save category",e);
 			throw e;
-		}finally { sProvider.close() ;}
+		}
 	}
 	
 	public void saveModOfCategory(List<String> moderatorCate, String userId, boolean isAdd) {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node cateHome = getCategoryHome(sProvider);
 			Node cateNode = null;
@@ -918,7 +908,7 @@
 			cateHome.save();
 		} catch (Exception e) {
 			log.error("Failed to save moderator of category",e);
-		}finally { sProvider.close() ;}
+		}
 	}
 	
 	
@@ -1120,7 +1110,7 @@
 	}
 	
 	public void registerListenerForCategory(String path) throws Exception{
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
 			String id = path.substring(path.lastIndexOf("/") + 1) ;
@@ -1135,17 +1125,15 @@
 			}
 		}catch(Exception e) {
 			log.error("Failed to register listener for category " +path, e);
-		} finally{ sProvider.close() ;}
+		}
 	}
  	
 	public void unRegisterListenerForCategory(String path) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider();
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			unRegisterListenerForCategory(sProvider, path);
 		} catch (Exception e) {
 			log.error("Failed to unregister listener for category " + path, e);
-		} finally {
-			sProvider.close();
 		}
 	}
 	
@@ -1158,7 +1146,7 @@
 	}
 	
 	public Category removeCategory(String categoryId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ; 
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
 			Node categoryNode = categoryHome.getNode(categoryId) ;
@@ -1188,7 +1176,7 @@
 		} catch(Exception e) {
 			log.error("failed to remove category " +categoryId);
 			return null ;
-		}finally { sProvider.close() ;}		
+		}
 	}
 
 	public List<Forum> getForums(String categoryId, String strQuery) throws Exception {
@@ -1200,7 +1188,7 @@
 	 }
 	
 	private List<Forum> getForums(String categoryId, String strQuery, boolean summary) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ; 
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			SortSettings sort = getForumSortSettings();
 			SortField orderBy = sort.getField();
@@ -1245,22 +1233,22 @@
 		} catch (Exception e) {
 			log.error("Error retrieving forums for category " + categoryId, e);
 			return new ArrayList<Forum>();
-		}finally{ sProvider.close() ;}
+		}
 	}
 
 	public Forum getForum(String categoryId, String forumId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ; 
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumNode = getCategoryHome(sProvider).getNode(categoryId+"/"+forumId);
 			return getForum(forumNode);			
 		} catch (Exception e) {
 		 log.error("\nCould not get " + forumId + " in " + categoryId	+ " fail: "+ e.getCause());
 			return null;
-		} finally{ sProvider.close() ;}
+		}
 	}
 
 	public void modifyForum(Forum forum, int type) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumHomeNode = getForumHomeNode(sProvider);
 			String forumPath = forum.getPath();
@@ -1285,7 +1273,7 @@
 			}
 		} catch (RepositoryException e) {
 			log.error("Failed to modify forum " + forum.getForumName(), e);
-		}finally{ sProvider.close() ;}
+		}
 	}
 
 	/**
@@ -1306,7 +1294,7 @@
 	}
 	
 	public void saveForum(String categoryId, Forum forum, boolean isNew) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node forumNode = null;
 		String[] strModerators = forum.getModerators();
 		try {
@@ -1410,7 +1398,7 @@
 			}
 		} catch (Exception e) {
 			log.error("Failed to save forum " + forum.getForumName(),e);
-		}finally{ sProvider.close() ;}
+		}
 	}
 	
 	//TODO: View again
@@ -1503,7 +1491,7 @@
 	}
 	
 	public void saveModerateOfForums(List<String> forumPaths, String userName, boolean isDelete) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node categoryHomeNode = getCategoryHome(sProvider);
 		for (String path : forumPaths) {
 			String forumPath = categoryHomeNode.getPath() + "/" + path;
@@ -1565,7 +1553,6 @@
 		} else {
 			categoryHomeNode.save();
 		}
-		sProvider.close() ;
 	}
 
 	/**
@@ -1651,7 +1638,7 @@
 	}
 
 	public Forum removeForum(String categoryId, String forumId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Forum forum = null;
 		try {
 			Node catNode = getCategoryHome(sProvider).getNode(categoryId);
@@ -1669,12 +1656,12 @@
 			}catch(Exception e){}			
 		} catch(Exception e) {
 			return null;
-		}finally{ sProvider.close() ;}
+		}
 		return forum;
 	}
 
 	public void moveForum(List<Forum> forums, String destCategoryPath) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumHomeNode = getForumHomeNode(sProvider);
 			String oldCatePath = "";
@@ -1720,7 +1707,7 @@
 			}
 		}catch(Exception e) {
 			log.error("Failed to move forum",e);
-		}finally{ sProvider.close() ;}
+		}
 	}
 
 	private void setActiveTopicByForum(SessionProvider sProvider, Node forumNode, boolean isClosed) throws Exception {
@@ -1766,7 +1753,7 @@
 	}
 
 	public JCRPageList getPageTopic(String categoryId, String forumId, String strQuery, String strOrderBy) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ; 
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryNode = getCategoryHome(sProvider).getNode(categoryId);
 			Node forumNode = categoryNode.getNode(forumId);
@@ -1780,14 +1767,14 @@
 			return pagelist;
 		} catch (Exception e) {
 			return null;
-		}finally{ sProvider.close() ;}
+		}
 	}
 	
 	public LazyPageList<Topic> getTopicList(String categoryId,
 																			String forumId,
 																			String xpathConditions,
 																			String strOrderBy, int pageSize) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider();
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryNode = getCategoryHome(sProvider).getNode(categoryId);
 			Node forumNode = categoryNode.getNode(forumId);
@@ -1804,8 +1791,6 @@
 		} catch (Exception e) {
 			log.error("Failed to retrieve topic list for forum " + forumId, e);
 			return null;
-		} finally {
-			sProvider.close();
 		}
 	}
 	//
@@ -1862,7 +1847,7 @@
 	}
 
 	public List<Topic> getTopics(String categoryId, String forumId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumNode = getCategoryHome(sProvider).getNode(categoryId).getNode(forumId);
 			NodeIterator iter = forumNode.getNodes();
@@ -1876,11 +1861,11 @@
 			return topics;
 		} catch (Exception e) {
 			return null;
-		}finally { sProvider.close() ;}
+		}
 	}
 	
 	public void setViewCountTopic(String path, String userRead) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node topicNode = getCategoryHome(sProvider).getNode(path);
 			if (userRead != null &&	userRead.length() > 0 && !userRead.equals(UserProfile.USER_GUEST)) {
@@ -1893,23 +1878,23 @@
 				}
 			}
 		} catch (Exception e) {
-		}finally { sProvider.close() ;}
+		}
 	}
 	
 	public Topic getTopic(String categoryId, String forumId, String topicId, String userRead) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node topicNode = getCategoryHome(sProvider).getNode(categoryId+"/"+forumId+"/"+topicId);
 			return getTopicNode(topicNode);
 		} catch (Exception e) {
 			log.error("Getting Topic fail: " + e.getMessage() + "\n" + e.getCause());
 			return null;
-		}finally { sProvider.close() ;}
+		}
 	}
 
 	public Topic getTopicSummary(String topicPath, boolean isLastPost) throws Exception {
 		Topic topic = null;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {			
 			Node cateHomeNode = getCategoryHome(sProvider);
 			if (topicPath == null || topicPath.length() <= 0)
@@ -1934,14 +1919,14 @@
 			return topic ;
 		}catch(Exception e) {
 			return null ;
-		}finally{sProvider.close() ;}
+		}
 		
 	}
 	
 	
 	public Topic getTopicByPath(String topicPath, boolean isLastPost) throws Exception {
 		Topic topic = null;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {			
 			Node catogoryHome = getCategoryHome(sProvider);
 			if (topicPath == null || topicPath.length() <= 0)
@@ -1966,7 +1951,7 @@
 			return topic ;
 		}catch(Exception e) {
 			return null ;
-		}finally{sProvider.close() ;}
+		}
 		
 	}
 
@@ -2030,7 +2015,7 @@
 	}	
 	
 	public Topic getTopicUpdate(Topic topic, boolean isSummary) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider();
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumHomeNode = getForumHomeNode(sProvider);
 			Node topicNode = (Node)forumHomeNode.getSession().getItem(topic.getPath());
@@ -2093,8 +2078,6 @@
 			} catch (Exception e) {}
 		} catch (Exception e) {
 			e.printStackTrace();
-		}finally {
-			sProvider.close();
 		}
 		return topic;
 	}
@@ -2174,7 +2157,7 @@
 	}
 
 	public JCRPageList getPageTopicOld(long date, String forumPatch) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
 			Calendar newDate = getGreenwichMeanTime();
@@ -2190,11 +2173,11 @@
 			return pagelist;
 		} catch (Exception e) {
 			return null;
-		} finally{ sProvider.close() ;}
+		}
 	}
 
 	public List<Topic> getAllTopicsOld(long date, String forumPatch) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<Topic> topics = new ArrayList<Topic>();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
@@ -2218,12 +2201,12 @@
 				topics.add(topic);
 			}
 		} catch (Exception e) {
-		} finally{ sProvider.close() ;}
+		}
 		return topics;
 	}
 	
 	public long getTotalTopicOld(long date, String forumPatch) {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
 			Calendar newDate = getGreenwichMeanTime();
@@ -2237,11 +2220,11 @@
 			return iter.getSize();
 		} catch (Exception e) {
 			return 0;
-		} finally{ sProvider.close() ;}
+		}
 	}
 
 	public JCRPageList getPageTopicByUser(String userName, boolean isMod, String strOrderBy) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
 			QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -2262,12 +2245,11 @@
 			return pagelist;
 		} catch (Exception e) {
 			return null;
-		} finally { sProvider.close() ;}
+		}
 	}
 
 	public void modifyTopic(List<Topic> topics, int type) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-		try {
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 			Node forumHomeNode = getForumHomeNode(sProvider);
 			List<String>userIdsp = new ArrayList<String>();
 			long topicCount = 0;
@@ -2365,13 +2347,10 @@
 			} else {
 				forumNode.save();
 			}
-		}finally {
-			sProvider.close() ;
-		}
 	}
 
 	public void saveTopic(String categoryId, String forumId, Topic topic, boolean isNew, boolean isMove, String defaultEmailContent) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumNode = getCategoryHome(sProvider).getNode(categoryId + "/" + forumId);
 			Node topicNode;
@@ -2501,7 +2480,7 @@
 			}
 		}catch(Exception e) {
 			log.error("Failed to save topic",e);
-		} finally { sProvider.close() ;}		
+		}
 	}
 	
 	private Map<String, Long> getDeletePostByUser(Node node) throws Exception	{
@@ -2527,7 +2506,7 @@
 	}
 
 	public void updateUserProfileInfo(String name) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try{
 			Node userProfileHome = getUserProfileHome(sProvider) ;
 			Node userNode = null ;
@@ -2544,8 +2523,6 @@
 			infoMap.remove(name) ;
 		}catch(Exception e) {
 			log.error("Failed to update user profile info",e);
-		}finally{
-			sProvider.close();
 		}
 	}	 
 
@@ -2566,7 +2543,7 @@
 	}
 
 	public Topic removeTopic(String categoryId, String forumId, String topicId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumNode = getCategoryHome(sProvider).getNode(categoryId + "/" +forumId);
 			Topic topic = getTopic(categoryId, forumId, topicId, UserProfile.USER_GUEST);
@@ -2602,7 +2579,7 @@
 			return topic;
 		} catch (Exception e) {
 			return null;
-		} finally {sProvider.close() ;}
+		}
 	}
 
 	private String getEmailUser(SessionProvider sProvider, String userId) throws Exception {
@@ -2610,7 +2587,7 @@
 	}
 	
 	public void moveTopic(List<Topic> topics, String destForumPath, String mailContent, String link) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumHomeNode = getForumHomeNode(sProvider);
 			long tmp = 0;
@@ -2712,7 +2689,7 @@
 		}catch(Exception e) {			
 			log.error("Failed to move topic",e);
 			throw e;
-		} finally { sProvider.close() ;}		
+		}
 	}
 
 	private Set<String> calculateMoveEmail(Node node) throws Exception {
@@ -2792,7 +2769,7 @@
 	}
 	
 	public long getLastReadIndex(String path, String isApproved, String isHidden, String userLogin) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;	
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node catNode = getCategoryHome(sProvider);
 			Node postNode = catNode.getNode(path);
@@ -2821,12 +2798,12 @@
 				return size;
 			}
 		} catch (Exception e) {
-		}finally { sProvider.close() ;}
+		}
 		return 0;
 	}
 	
 	public JCRPageList getPostForSplitTopic(String topicPath) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;		
+		SessionProvider sProvider = CommonUtils.createSystemProvider();	
 		try {
 			Node topicNode = getCategoryHome(sProvider).getNode(topicPath);
 			StringBuffer stringBuffer = new StringBuffer();
@@ -2840,12 +2817,12 @@
 			JCRPageList pagelist = new ForumPageList(iter, 10, stringBuffer.toString(), true);
 			return pagelist;
 		} catch (PathNotFoundException e) {
-		} finally { sProvider.close() ;}
+		}
 		return null;
 	}
 	
 	public JCRPageList getPosts(String categoryId, String forumId, String topicId, String isApproved, String isHidden, String strQuery, String userLogin) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;		
+		SessionProvider sProvider = CommonUtils.createSystemProvider();	
 		try {
 			Node topicNode = getCategoryHome(sProvider).getNode(categoryId + "/" + forumId +"/" + topicId);
 			StringBuffer stringBuffer = new StringBuffer();
@@ -2856,13 +2833,13 @@
 			return pagelist;				
 		} catch (PathNotFoundException e) {
 			return null;
-		} finally { sProvider.close() ;}
+		}
 	}
 
 	
 
 	public long getAvailablePost(String categoryId, String forumId, String topicId, String isApproved, String isHidden, String userLogin) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ; 
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			StringBuilder strBuilder = new StringBuilder();
 			strBuilder.append(categoryId).append("/").append(forumId).append("/").append(topicId);
@@ -2877,11 +2854,11 @@
 			return iter.getSize();				
 		} catch (PathNotFoundException e) {
 			return 0;
-		} finally{ sProvider.close() ;}
+		}
 	}
 
 	public JCRPageList getPagePostByUser(String userName, String userId, boolean isMod, String strOrderBy) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
 			QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -2904,11 +2881,11 @@
 			return pagelist;
 		} catch (Exception e) {
 			return null;
-		} finally{ sProvider.close() ;}
+		}
 	}
 
 	public Post getPost(String categoryId, String forumId, String topicId, String postId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
 			Node postNode ;
@@ -2922,11 +2899,11 @@
 			return getPost(postNode);
 		} catch (PathNotFoundException e) {
 			return null;
-		} finally {sProvider.close() ;}
+		}
 	}
 	
 	public JCRPageList getListPostsByIP(String ip, String strOrderBy) throws Exception{
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
 			QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -2949,7 +2926,7 @@
 			return pagelist;
 		}catch (Exception e){ 
 			return null ;
-		} finally { sProvider.close() ;}		
+		}
 	}
 
 	public Post getPost(Node postNode) throws Exception {
@@ -2999,7 +2976,7 @@
 	}
 
 	public void savePost(String categoryId, String forumId, String topicId, Post post, boolean isNew, String defaultEmailContent) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node CategoryNode = getCategoryHome(sProvider).getNode(categoryId);
 			Node forumNode = CategoryNode.getNode(forumId);
@@ -3210,8 +3187,6 @@
 			}
 		} catch (Exception e) {
 			log.error("Failed to save post" + post.getName(),e);
-		}finally {
-			sProvider.close() ;
 		}
 	}
 
@@ -3224,7 +3199,7 @@
 	private void sendNotification(Node node, Topic topic, Post post, String defaultEmailContent, boolean isApprovePost) throws Exception {
 		Node forumAdminNode = null;
 		String headerSubject="",catName="",forumName="",topicName="";
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			try {
 				forumAdminNode = getAdminHome(sProvider).getNode(Utils.FORUMADMINISTRATION);
@@ -3578,13 +3553,11 @@
 			}
 		} catch (Exception e) {
 			log.error("Failed to send notification.", e);
-		} finally {
-			sProvider.close() ;
 		}
 	}
 
 	public void modifyPost(List<Post> posts, int type) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumHomeNode = getForumHomeNode(sProvider);
 			for (Post post : posts) {
@@ -3666,8 +3639,6 @@
 			}
 		} catch (Exception e) {
 			log.error("Failed to modify posts",e);
-		} finally {
-			sProvider.close() ;
 		}
 	}
 
@@ -3690,7 +3661,7 @@
 	}
 
 	public Post removePost(String categoryId, String forumId, String topicId, String postId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Post post;
 		try {
 			Node CategoryNode = getCategoryHome(sProvider).getNode(categoryId);
@@ -3748,11 +3719,11 @@
 			return post;			
 		} catch (Exception e) {
 			return null;
-		} finally { sProvider.close() ;}
+		}
 	}
 
 	public void movePost(String[] postPaths, String destTopicPath, boolean isCreatNewTopic, String mailContent, String link) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumHomeNode = getForumHomeNode(sProvider);
 			// Node Topic move Post
@@ -3909,11 +3880,11 @@
 			}
 		}catch (Exception e) {
 			throw e;
-		}finally {sProvider.close() ;}
+		}
 	}
 
 	public void mergeTopic(String srcTopicPath, String destTopicPath, String mailContent, String link) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node srcTopicNode = getCategoryHome(sProvider).getNode(srcTopicPath);
 			NodeIterator iter = srcTopicNode.getNodes();
@@ -3943,7 +3914,7 @@
 			}
 		} catch (Exception e) {
 			throw e;
-		} finally { sProvider.close() ;}
+		}
 	}
 	
 	/*public Poll getPoll(String categoryId, String forumId, String topicId) throws Exception {
@@ -4085,7 +4056,7 @@
 	}*/
 
 	public void addTag(List<Tag> tags, String userName, String topicPath) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			boolean isAdd;
 			Node topicNode = (Node) getCategoryHome(sProvider).getSession().getItem(topicPath);
@@ -4118,12 +4089,12 @@
 			
 		}catch (Exception e) {
 			log.error("Failed to add tags",e);
-		}finally {sProvider.close() ;}
+		}
 		
 	}
 
 	public void unTag(String tagId, String userName, String topicPath) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
 			Node topicNode = (Node) categoryHome.getSession().getItem(topicPath);
@@ -4170,21 +4141,21 @@
 			}
 		}catch(Exception e) {
 			log.error("Failed to untag.",e);
-		} finally { sProvider.close() ;}
+		}
 	}
 
 	public Tag getTag(String tagId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node tagNode = getTagHome(sProvider).getNode(tagId);
 			return getTagNode(tagNode);
 		} catch (Exception e) {
 			return null;
-		} finally {sProvider.close() ;}
+		}
 	}
 	
 	public List<String> getTagNameInTopic(String userAndTopicId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<String> tagNames = new ArrayList<String>();
 		try {
 			Node tagHome = getTagHome(sProvider);
@@ -4260,11 +4231,11 @@
 			return tagNames;
 		}catch(Exception e) {
 			return tagNames;
-		}finally { sProvider.close() ;}
+		}
 	}
 	
 	public List<String> getAllTagName(String keyValue, String userAndTopicId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<String> tagNames = new ArrayList<String>();
 		try {
 			Node tagHome = getTagHome(sProvider);
@@ -4316,11 +4287,11 @@
 			return tagNames;
 		}catch(Exception e) {
 			return tagNames;
-		}finally { sProvider.close() ;}
+		}
 	}
 	
 	public List<Tag> getAllTags() throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<Tag> tags = new ArrayList<Tag>();
 		try {
 			Node tagHome = getTagHome(sProvider);
@@ -4337,7 +4308,7 @@
 			return tags;
 		}catch(Exception e) {
 			return tags;
-		}finally { sProvider.close() ;}
+		}
 	}
 
 	private Tag getTagNode(Node tagNode) throws Exception {
@@ -4350,7 +4321,7 @@
 	}
 
 	public List<Tag> getMyTagInTopic(String[] tagIds) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<Tag> tags = new ArrayList<Tag>();
 		try {
 			Node tagHome = getTagHome(sProvider) ;
@@ -4362,11 +4333,11 @@
 			return tags;
 		}catch(Exception e) {
 			return tags;
-		} finally {sProvider.close() ;}
+		}
 	}
 
 	public JCRPageList getTopicByMyTag(String userIdAndtagId, String strOrderBy) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
 			QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -4394,11 +4365,11 @@
 			return pagelist;
 		}catch (Exception e) {
 			return null ;
-		} finally { sProvider.close() ;}		
+		}
 	}
 
 	public void saveTag(Tag newTag) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node tagHome = getTagHome(sProvider);
 			Node newTagNode;
@@ -4432,13 +4403,13 @@
 			}
 		}catch (Exception e) {
 			log.error("Failed to save tag.",e);
-		} finally { sProvider.close() ;}
+		}
 		
 	}
 
 
 	public JCRPageList getPageListUserProfile() throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try{
 			Node userProfileNode = getUserProfileHome(sProvider);
 			NodeIterator iterator = userProfileNode.getNodes();
@@ -4446,11 +4417,11 @@
 			return pageList;
 		}catch(Exception e) {
 			return null ;
-		}finally {sProvider.close() ;}		
+		}
 	}
 
 	public JCRPageList searchUserProfile(String userSearch) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try{
 			Node userProfileHome = getUserProfileHome(sProvider);
 			QueryManager qm = userProfileHome.getSession().getWorkspace().getQueryManager();
@@ -4465,14 +4436,13 @@
 			return pagelist;
 		}catch (Exception e){
 			return null ;
-		} finally{ sProvider.close() ;}
+		}
 	}
 
 	public UserProfile getDefaultUserProfile(String userName, String ip) throws Exception {
 		UserProfile userProfile = new UserProfile();
 		if (userName == null || userName.length() <= 0)	return userProfile;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-		try{
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 			Node profileNode = getUserProfileHome(sProvider).getNode(userName);
 			userProfile.setUserId(userName) ;
 			if(isAdminRole(userName)) {
@@ -4540,14 +4510,12 @@
 			} else if(ip != null) {
 				userProfile.setIsBanned(isBanIp(ip)) ;
 			}
-		}finally { sProvider.close() ;}
 		return userProfile ;
 	}
 	
 	public UserProfile updateUserProfileSetting(UserProfile userProfile) throws Exception{
 			if (userProfile.getIsBanned()) {
-				SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-				try{
+				SessionProvider sProvider = CommonUtils.createSystemProvider();
 					Node profileNode = getUserProfileHome(sProvider).getNode(userProfile.getUserId());
 					if(profileNode.hasProperty(EXO_BAN_UNTIL)) {
 						userProfile.setBanUntil(profileNode.getProperty(EXO_BAN_UNTIL).getLong());
@@ -4557,20 +4525,17 @@
 							userProfile.setIsBanned(false) ;
 						}
 					}
-				}finally { sProvider.close() ;}
 			}
 		return userProfile;
 	}
 	
 	
 	public String getScreenName(String userName) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider();
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			return getScreenName(sProvider, userName);
 		} catch (Exception e) {
 			return userName;
-		} finally {
-			sProvider.close();
 		}
 	}
 
@@ -4600,7 +4565,7 @@
 	public UserProfile getUserSettingProfile(String userName) throws Exception {
 		UserProfile userProfile = new UserProfile();
 		if (userName == null || userName.length() <= 0)	return userProfile;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try{
 			Node profileNode = getUserProfileHome(sProvider).getNode(userName);
 			userProfile.setUserId(userName) ;
@@ -4629,12 +4594,12 @@
 				userProfile.setUserTitle(Utils.ADMIN);
 				saveUserProfile(userProfile, false, false);
 			}
-		}finally{ sProvider.close() ;}
+		}
 		return userProfile ;
 	}
 	
 	public void saveUserSettingProfile(UserProfile userProfile) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node profileNode = getUserProfileHome(sProvider).getNode(userProfile.getUserId());
 		try{
 			profileNode.setProperty(EXO_USER_TITLE, userProfile.getUserTitle());
@@ -4655,11 +4620,11 @@
 			profileNode.save();
 		}catch(Exception e) {
 			log.error("Failed to save setting profile.",e);
-		}finally{ sProvider.close() ;}
+		}
 	}
 	
 	public UserProfile getLastPostIdRead(UserProfile userProfile, String isOfForum) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node profileNode = getUserProfileHome(sProvider).getNode(userProfile.getUserId());
 		try {
 			if(isOfForum.equals("true")) {
@@ -4689,12 +4654,12 @@
 				}
 			}
 		} catch (Exception e) {
-		}finally{ sProvider.close() ;}
+		}
 		return userProfile;
 	}
 
 	public void saveLastPostIdRead(String userId, String[] lastReadPostOfForum, String[] lastReadPostOfTopic) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node profileHome = getUserProfileHome(sProvider);
 		try {
 			Node profileNode = profileHome.getNode(userId);
@@ -4703,11 +4668,11 @@
 			profileHome.save();
 		} catch (Exception e) {
 			log.error("Failed to save last post id read.",e);
-		}finally{ sProvider.close() ;}
+		}
 	}
 	
 	public List<String> getUserModerator(String userName, boolean isModeCate) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node userProfileNode = getUserProfileHome(sProvider);
 		List<String> list = new ArrayList<String>();
 		try {
@@ -4717,12 +4682,12 @@
 			else
 				list.addAll(Utils.valuesToList(profileNode.getProperty(EXO_MODERATE_FORUMS).getValues()));
 		} catch (Exception e) {
-		}finally{ sProvider.close() ;}
+		}
 		return list;
 	}
 
 	public void saveUserModerator(String userName, List<String> ids, boolean isModeCate) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node userProfileNode = getUserProfileHome(sProvider);
 		try {
 			Node profileNode = userProfileNode.getNode(userName);
@@ -4732,7 +4697,7 @@
 				profileNode.setProperty(EXO_MODERATE_FORUMS, Utils.getStringsInList(ids));
 			profileNode.save();
 		} catch (Exception e) {
-		}finally{ sProvider.close() ;}
+		}
 	}
 	
 	private Node getUserProfileNode(Node profileHome, String userName) throws Exception {
@@ -4748,7 +4713,7 @@
 	public UserProfile getUserInfo(String userName) throws Exception {
 		UserProfile userProfile = new UserProfile();
 		if (userName == null || userName.length() <= 0) return userProfile;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node userProfileNode = getUserProfileHome(sProvider);
 		Node newProfileNode;
 		try {
@@ -4788,14 +4753,14 @@
 				userProfile.setUserTitle(Utils.ADMIN);
 				saveUserProfile(userProfile, false, false);
 			}			
-		} finally{ sProvider.close() ;}
+		}
 		return userProfile;
 	}
 	
 	public List<UserProfile> getQuickProfiles(List<String> userList) throws Exception {
 		UserProfile userProfile ;
 		List<UserProfile> profiles = new ArrayList<UserProfile>() ;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		PropertyReader reader ;
 		Node userProfileNode;
 		try {
@@ -4821,14 +4786,13 @@
 			}
 		} catch (Exception e) {
 			log.trace("\nUser Name must exist: "+	e.getMessage() + "\n" + e.getCause());
-		}finally {sProvider.close() ;}		
+		}
 		return profiles ;		
 	}
 	
 	public UserProfile getQuickProfile(String userName) throws Exception {
 		UserProfile userProfile ;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-		try{
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 			Node userProfileHome = getUserProfileHome(sProvider);
 			userProfile = new UserProfile();
 			Node userProfileNode = getUserProfileNode(userProfileHome, userName);
@@ -4846,20 +4810,17 @@
 			userProfile.setLastLoginDate(reader.date(EXO_LAST_LOGIN_DATE)) ;
 			userProfile.setIsDisplaySignature(reader.bool(EXO_IS_DISPLAY_SIGNATURE, false)) ;
 			if(userProfile.getIsDisplaySignature()) userProfile.setSignature(reader.string(EXO_SIGNATURE, "")) ;
-		}finally { sProvider.close() ;}		
 		return userProfile ;		
 	}
 	
 	public UserProfile getUserInformations(UserProfile userProfile) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-		try {
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 			Node userProfileHome = getUserProfileHome(sProvider);
 			Node profileNode = getUserProfileNode(userProfileHome, userProfile.getUserId()) ;			
 			userProfile.setFirstName(profileNode.getProperty(EXO_FIRST_NAME).getString()) ;
 			userProfile.setLastName(profileNode.getProperty(EXO_LAST_NAME).getString()) ;
 			userProfile.setFullName(profileNode.getProperty(EXO_FULL_NAME).getString()) ;
 			userProfile.setEmail(profileNode.getProperty(EXO_EMAIL).getString()) ;
-		}finally{ sProvider.close() ;}
 		return userProfile ;
 	}
 	
@@ -4867,9 +4828,8 @@
 		Node newProfileNode;
 		String userName = newUserProfile.getUserId();
 		if (userName == null || userName.length() <= 0)	return ;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node userProfileHome = getUserProfileHome(sProvider);
-		try{
 			long role = 2;
 			try {
 				newProfileNode = userProfileHome.getNode(userName);
@@ -4936,17 +4896,16 @@
 			if(role >=2 && newUserProfile.getUserRole() < 2 && !isAdminRole(userName)) {
 				getTotalJobWaitingForModerator(userProfileHome.getSession(), userName);
 			}
-		} finally { sProvider.close() ;}
 	}
 
 	public UserProfile getUserProfileManagement(String userName) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node userProfileNode = getUserProfileNode(getUserProfileHome(sProvider), userName);
 			return getUserProfile(userProfileNode);
 		}catch (Exception e) {
 			return null ;
-		}finally { sProvider.close() ;}
+		}
 	}
 	
 	private UserProfile getUserProfile(Node userProfileNode) throws Exception {
@@ -5002,7 +4961,7 @@
 	
 	public void saveUserBookmark(String userName, String bookMark, boolean isNew) throws Exception {
 		Node newProfileNode;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node userProfileNode = getUserProfileHome(sProvider);		
 		try {			
 			newProfileNode = userProfileNode.getNode(userName);
@@ -5055,11 +5014,11 @@
 			} else {
 				newProfileNode.save();
 			}
-		}finally { sProvider.close() ;}
+		}
 	}
 
 	public void saveCollapsedCategories(String userName, String categoryId, boolean isAdd) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node userProfileHome = getUserProfileHome(sProvider);
 		Node newProfileNode;
 		try {
@@ -5107,13 +5066,12 @@
 			} else {
 				newProfileNode.save();
 			}
-		} finally { sProvider.close() ;}
+		}
 	}
 
 	public void saveReadMessage(String messageId, String userName, String type) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node userProfileNode = getUserProfileHome(sProvider);
-		try {
 			Node profileNode = userProfileNode.getNode(userName);
 			long totalNewMessage = 0;
 			boolean isNew = false;
@@ -5143,11 +5101,10 @@
 					userProfileNode.save();
 				}
 			}
-		}finally { sProvider.close() ;}		
 	}
 
 	public JCRPageList getPrivateMessage(String userName, String type) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node userProfileNode = getUserProfileHome(sProvider);
 		try {
 			Node profileNode = userProfileNode.getNode(userName);
@@ -5160,11 +5117,11 @@
 			return pagelist;
 		} catch (Exception e) {
 			return null ;
-		}finally { sProvider.close() ;}
+		}
 	}
 	
 	public long getNewPrivateMessage(String userName) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node userProfileNode = getUserProfileHome(sProvider);
 		try {
 			Node profileNode = userProfileNode.getNode(userName);
@@ -5173,14 +5130,12 @@
 			}
 		} catch (PathNotFoundException e) {
 			return -1;
-		} finally {
-			sProvider.close();
 		}
 		return -1;
 	}
 	
 	public void savePrivateMessage(ForumPrivateMessage privateMessage) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node userProfileNode = getUserProfileHome(sProvider);
 		Node profileNode = null;
 		Node profileNodeFirst = null;
@@ -5237,7 +5192,6 @@
 		} else {
 			userProfileNode.save();
 		}
-		sProvider.close() ;
 	}
 
 	private Node addNodeUserProfile(SessionProvider sProvider, String userName) throws Exception {
@@ -5259,7 +5213,7 @@
 	}
 
 	public void removePrivateMessage(String messageId, String userName, String type) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;		
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node userProfileNode = getUserProfileHome(sProvider);
 		Node profileNode = userProfileNode.getNode(userName);
 		try {
@@ -5278,11 +5232,11 @@
 			profileNode.save();			
 		} catch (PathNotFoundException e) {
 			log.error("Failed to remove private message",e);
-		}finally { sProvider.close() ;}
+		}
 	}
 
 	public ForumSubscription getForumSubscription(String userId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		ForumSubscription forumSubscription = new ForumSubscription();
 		try {
 			Node subscriptionNode = getUserProfileHome(sProvider).getNode(userId+"/"+Utils.FORUM_SUBSCRIOTION+userId);
@@ -5293,12 +5247,12 @@
 			if(subscriptionNode.hasProperty(EXO_TOPIC_IDS))
 				forumSubscription.setTopicIds(Utils.valuesToArray(subscriptionNode.getProperty(EXO_TOPIC_IDS).getValues()));
 		} catch (Exception e) {
-		}finally {sProvider.close();}
+		}
 		return forumSubscription;
 	}
 	
 	public void saveForumSubscription(ForumSubscription forumSubscription, String userId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node profileNode = getUserProfileHome(sProvider).getNode(userId);
 			Node subscriptionNode;
@@ -5318,7 +5272,7 @@
 			}
 		} catch (Exception e) {
 			log.error("Failed to save forum subscription.",e);
-		}finally {sProvider.close();}
+		}
 	}
 	
 	private String[] getValueProperty(Node node, String property, String objectId) throws Exception {
@@ -5333,7 +5287,7 @@
 	}
 	
 	public ForumStatistic getForumStatistic() throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		ForumStatistic forumStatistic = new ForumStatistic();
 		try {
 			Node forumStatisticNode = getForumStatisticsNode(sProvider);
@@ -5346,12 +5300,12 @@
 			forumStatistic.setMostUsersOnline(reader.string(EXO_MOST_USERS_ONLINE,""));
 		} catch (Exception e) {
 			log.error("Failed to load forum statistics", e);
-		}finally { sProvider.close() ;}
+		}
 		return forumStatistic;
 	}
 
 	public void saveForumStatistic(ForumStatistic forumStatistic) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node forumStatisticNode = getForumStatisticsNode(sProvider);
 			forumStatisticNode.setProperty(EXO_POST_COUNT, forumStatistic.getPostCount());
@@ -5367,7 +5321,7 @@
 			}
 		}catch (Exception e) {
 			log.error("Failed to save forum statistics", e);
-		}finally { sProvider.close() ;}				
+		}	
 	}
 
 	public Calendar getGreenwichMeanTime() {
@@ -5379,7 +5333,7 @@
 	}
 
 	public Object getObjectNameByPath(String path) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Object object;
 		try {
 			if(path.indexOf(KSDataLocation.Locations.FORUM_CATEGORIES_HOME) < 0 && (path.indexOf(Utils.CATEGORY) >= 0)) {
@@ -5422,12 +5376,12 @@
 			return object;
 		} catch (RepositoryException e) {
 			return null;
-		} finally { sProvider.close() ;}
+		}
 	}
 	
 	public Object getObjectNameById(String id, String type) throws Exception {
 		Object object = null;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node node = getNodeById(sProvider, id, type);
 			if(type.equals(Utils.CATEGORY)) {
@@ -5445,7 +5399,7 @@
 			}
 		}catch (Exception e) {
 			log.error("Can not get "+type+" by Id: " + id, e);
-		}finally{ sProvider.close() ;}
+		}
 		return object;
 	}
 	
@@ -5468,8 +5422,7 @@
 
 	public List<ForumLinkData> getAllLink(String strQueryCate, String strQueryForum) throws Exception {
 		List<ForumLinkData> forumLinks = new ArrayList<ForumLinkData>();
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-		try{
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 			Node categoryHome = getCategoryHome(sProvider);
 			QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
 			StringBuffer queryString = new StringBuffer();
@@ -5505,7 +5458,6 @@
 					}
 				}
 			}
-		}finally { sProvider.close() ;}
 		return forumLinks;
 	}
 
@@ -5513,7 +5465,7 @@
 																					String pathQuery, String userId, List<String> listCateIds, 
 																					List<String> listForumIds, List<String> forumIdsOfModerator) throws Exception {
 		List<ForumSearch> listSearchEvent = new ArrayList<ForumSearch>();
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
 			QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -5661,8 +5613,6 @@
 			}
 		} catch (Exception e) {
 			throw e;
-		}finally{
-			sProvider.close() ;
 		}
 		return listSearchEvent;
 	}
@@ -5722,7 +5672,7 @@
 	}
 
 	public List<ForumSearch> getAdvancedSearch(ForumEventQuery eventQuery, List<String> listCateIds, List<String> listForumIds) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<ForumSearch> listSearchEvent = new ArrayList<ForumSearch>();
 		try {
 			Node categoryHome = getCategoryHome(sProvider) ;
@@ -5769,9 +5719,7 @@
 					listSearchEvent = removeItemInList(listSearchEvent,forumCanView,categoryCanView);
 			}
 		} catch (Exception e) {
-		}finally {
-			sProvider.close() ;
-		}		
+		}	
 		return listSearchEvent;
 	}
 
@@ -5968,7 +5916,7 @@
 	}
 	
 	public void addWatch(int watchType, String path, List<String> values, String currentUser) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryHome = getCategoryHome(sProvider) ;
 			if(watchType == -1) {
@@ -6030,13 +5978,13 @@
 //			if(watchType == -1)addForumSubscription(sProvider, currentUser, watchingNode.getName());
 		} catch (Exception e) {
 			log.error("Can not add Watch for user: " + currentUser,e);
-		}finally {sProvider.close() ;}
+		}
 	}
 
 	public void removeWatch(int watchType, String path, String values) throws Exception {
 		if(Utils.isEmpty(values)) return ;
 		Node watchingNode = null;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ; 
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node categoryHome = getCategoryHome(sProvider) ;
 		String string = categoryHome.getPath();
 		if (path.indexOf(categoryHome.getName()) < 0)
@@ -6081,11 +6029,11 @@
 			}
 		} catch (Exception e) {
 			log.error("Failed to remove watch.",e);
-		} finally{ sProvider.close() ;}
+		}
 	}
 	
 	public void updateEmailWatch(List<String> listNodeId, String newEmailAdd, String userId) throws Exception{
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node parentNode = getForumHomeNode(sProvider) ;
 			QueryManager qm = parentNode.getSession().getWorkspace().getQueryManager();
@@ -6126,12 +6074,12 @@
 			}
 		}catch(Exception e) {
 			log.error("Failed to update email watch.",e);
-		}finally { sProvider.close() ;}
+		}
 		
 	}
 	
 	public List<Watch> getWatchByUser(String userId) throws Exception{
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<Watch> listWatches = new ArrayList<Watch>();
 		try {
 			Node categoryHome = getCategoryHome(sProvider) ;	
@@ -6189,7 +6137,7 @@
 			return listWatches;
 		}catch(Exception e) {
 			return listWatches ;
-		}finally { sProvider.close() ;}
+		}
 		
 	}
 
@@ -6216,7 +6164,7 @@
 		Map<String, Long> topicMap = new HashMap<String, Long>() ;
 		Map<String, Long> postMap = new HashMap<String, Long>() ;
 		if(path.indexOf("/") > 0) path = "/"+path;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try{
 			Node forumStatisticNode = getStatisticHome(sProvider).getNode(Locations.FORUM_STATISTIC);
 			QueryManager qm = forumStatisticNode.getSession().getWorkspace().getQueryManager() ;
@@ -6320,7 +6268,7 @@
 			}
 		}catch(Exception e) {
 			log.error("Failed to update forum",e);
-		}finally{ sProvider.close() ;}
+		}
 	}
 	
 	public SendMessageInfo getMessageInfo(String name) throws Exception {
@@ -6338,7 +6286,7 @@
 	}
 
 	public List<ForumSearch> getJobWattingForModerator(String[] paths) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<ForumSearch> list = new ArrayList<ForumSearch>();
 		try {
 			Node categoryHome = getCategoryHome(sProvider);
@@ -6398,16 +6346,13 @@
 				list.add(forumSearch);
 			}
 		}catch (Exception e) {
-		}finally {
-			sProvider.close();
 		}
 		return list;
 	}
 
 	public int getJobWattingForModeratorByUser(String userId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		int job = 0;
-		try {
 			Node newProfileNode = getUserProfileHome(sProvider).getNode(userId);
 			long t;// = 3
 			if (isAdminRole(userId)) {
@@ -6422,9 +6367,6 @@
 					job = 0 ;
 				}
 			}
-		}finally{
-			sProvider.close();
-		}
 		return job;
 	}
 	
@@ -6504,12 +6446,8 @@
 	}
 
 	public void getTotalJobWatting(List<String> userIds) {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-		try{
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 			getTotalJobWatting(sProvider, userIds);
-		} finally {
-			sProvider.close() ;
-		}
 	}
 	
 	protected ContinuationService getContinuationService() {
@@ -6518,7 +6456,7 @@
 	}
 	 
 	public NodeIterator search(String queryString) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try{
 			QueryManager qm = getForumHomeNode(sProvider).getSession().getWorkspace().getQueryManager() ;			
 			Query query = qm.createQuery(queryString, Query.XPATH);
@@ -6526,12 +6464,12 @@
 			return result.getNodes();
 		}catch(Exception e) {
 			log.error("Failed to search",e);
-		} finally {sProvider.close() ;}
+		}
 		return null ;
 	}
 
 	public void evaluateActiveUsers(String strQuery) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			String path = getUserProfileHome(sProvider).getPath() ;
 			StringBuilder stringBuilder = new StringBuilder();
@@ -6558,7 +6496,7 @@
 				saveForumStatistic(forumStatistic) ;
 			}
 		}catch (Exception e) {
-		}finally { sProvider.close() ;}		
+		}
 	}
 	
 	protected List<File> createCategoryFiles(List<String> objectIds, SessionProvider sessionProvider) throws Exception{
@@ -6661,7 +6599,7 @@
 	
 	public Object exportXML(String categoryId, String forumId, List<String> objectIds, String nodePath,
 													ByteArrayOutputStream bos, boolean isExportAll) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider();
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			List<File> listFiles = new ArrayList<File>();
 			
@@ -6710,7 +6648,7 @@
 			return file;
 		} catch (Exception e) {
 			return null;
-		}finally { sProvider.close() ;}
+		}
 	}
 
 	public void importXML(String nodePath, ByteArrayInputStream bis, int typeImport) throws Exception {
@@ -6726,7 +6664,7 @@
 		Document doc = docBuilder.parse(is);
 		doc.getDocumentElement ().normalize();
 		String typeNodeExport = doc.getFirstChild().getChildNodes().item(0).getChildNodes().item(0).getTextContent();
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<String> patchNodeImport = new ArrayList<String>();
 		try {
 		is = new ByteArrayInputStream(bdata) ;
@@ -6812,7 +6750,6 @@
 			updateForum (null);
 		}
 		} finally {
-			sProvider.close() ;
 			is.close();
 		}
 	}
@@ -6922,7 +6859,7 @@
 	}*/
 
 	public void updateTopicAccess (String userId, String topicId) throws Exception {
-		SessionProvider sysSession = SessionProvider.createSystemProvider() ;
+		SessionProvider sysSession = CommonUtils.createSystemProvider();
 		try {
 			Node profile = getUserProfileHome(sysSession).getNode(userId) ;
 			List<String> values = new ArrayList<String>() ;
@@ -6946,13 +6883,11 @@
 			profile.setProperty(EXO_READ_TOPIC, values.toArray(new String[values.size()])) ;
 			profile.save() ;
 		} catch (Exception e) {
-		}finally{
-			sysSession.close() ;
 		}
 	}
 	
 	public void updateForumAccess (String userId, String forumId) throws Exception {
-		SessionProvider sysSession = SessionProvider.createSystemProvider() ;
+		SessionProvider sysSession = CommonUtils.createSystemProvider();
 		try {
 			Node profile = getUserProfileHome(sysSession).getNode(userId) ;
 			List<String> values = new ArrayList<String>() ;
@@ -6977,15 +6912,12 @@
 			profile.save() ;
 
 		} catch (Exception e) {
-		}finally{
-			sysSession.close() ;
 		}
 	}
 	
 	public List<String> getBookmarks(String userName) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		Node profile = getUserProfileHome(sProvider).getNode(userName) ;
-		sProvider.close() ;
 		if(profile.hasProperty(EXO_BOOKMARK)) {
 			return Utils.valuesToList(profile.getProperty(EXO_BOOKMARK).getValues()) ;
 		}
@@ -6993,13 +6925,13 @@
 	}
 	
 	public List<String> getBanList() throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try{
 			Node banNode = getForumBanNode(sProvider) ;
 			if(banNode.hasProperty(EXO_IPS)) return Utils.valuesToList(banNode.getProperty(EXO_IPS).getValues()) ;
 		}catch(Exception e) {
 			log.error("Failed to get ban list",e);
-		}finally{ sProvider.close() ; }
+		}
 		return new ArrayList<String>() ;
 	}
 	
@@ -7007,7 +6939,7 @@
 		List<String> ips = getBanList() ;
 		if (ips.contains(ip)) return false ;
 		ips.add(ip) ;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try{
 			Node banNode = getForumBanNode(sProvider) ;
 			banNode.setProperty(EXO_IPS, ips.toArray(new String[ips.size()])) ;
@@ -7019,7 +6951,7 @@
 			return true ;
 		}catch(Exception e) {
 			log.error("Failed to add ban ip: " + ip,e);
-		}finally{ sProvider.close() ;}
+		}
 		return false ;
 	}
 	
@@ -7027,19 +6959,19 @@
 		List<String> ips = getBanList() ;
 		if (ips.contains(ip)){
 			ips.remove(ip);
-			SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+			SessionProvider sProvider = CommonUtils.createSystemProvider();
 			try{
 				Node banNode = getForumBanNode(sProvider) ;
 				banNode.setProperty(EXO_IPS, Utils.getStringsInList(ips)) ;
 				banNode.save() ;			
 			}catch(Exception e) {
 				log.error("Failed to remove ban, ip: " + ip,e);
-			}finally{ sProvider.close() ; }
+			}
 		}
 	}
 	
 	public List<String> getForumBanList(String forumId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<String> list = new ArrayList<String>();
 		try{
 			if(forumId.indexOf(".") > 0) forumId = StringUtils.replace(forumId, ".", "/");
@@ -7048,14 +6980,12 @@
 				list.addAll(Utils.valuesToList(forumNode.getProperty(EXO_BAN_I_PS).getValues()));
 		}catch(Exception e) {
 			log.error("Failed to get forum ban list.",e);
-		}finally {
-			sProvider.close() ;
 		}
 		return list ;
 	}
 	
 	public boolean addBanIPForum(String ip, String forumId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<String> ips = new ArrayList<String>() ;
 		try{
 			Node forumNode = getCategoryHome(sProvider).getNode(forumId);
@@ -7072,14 +7002,12 @@
 			return true ;
 		}catch(Exception e) {
 			log.error("Failed to add ban ip forum.",e);
-		}finally {
-			sProvider.close() ;
 		}
 		return false ;
 	}
 	
 	public void removeBanIPForum(String ip, String forumId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<String> ips = new ArrayList<String>() ;
 		try{
 			Node forumNode = getCategoryHome(sProvider).getNode(forumId);
@@ -7096,8 +7024,6 @@
 			}
 		}catch(Exception e) {
 			log.error("Failed to remove ban IP from forum",e);
-		}finally {
-			sProvider.close() ;
 		}
 	}
 	
@@ -7157,21 +7083,20 @@
 	}
 	
 	public PruneSetting getPruneSetting(String forumPath) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		PruneSetting pruneSetting = new PruneSetting();
 		try {
 			Node forumNode = (Node) getCategoryHome(sProvider).getSession().getItem(forumPath);
 			pruneSetting = getPruneSetting(forumNode.getNode(Utils.PRUNESETTING));
 		} catch (Exception e) {
 			log.debug("Failed to get Prune Settings: " + e.getMessage() + "\n" + e.getCause());
-		} finally { sProvider.close() ;}
+		}
 		return pruneSetting;
 	}
 	
 	public List<PruneSetting> getAllPruneSetting() throws Exception {
 		List<PruneSetting> prunList = new ArrayList<PruneSetting>();
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-		try{
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 			Node categoryHNode = getCategoryHome(sProvider);
 			QueryManager qm = categoryHNode.getSession().getWorkspace().getQueryManager();
 			StringBuilder pathQuery = new StringBuilder();
@@ -7183,13 +7108,12 @@
 				Node prunNode = iter.nextNode();
 				prunList.add(getPruneSetting(prunNode));
 			}
-		}finally { sProvider.close() ;}
 		return prunList;
 	}
 	
 
 	public void savePruneSetting(PruneSetting pruneSetting) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try{
 			String path = pruneSetting.getForumPath();
 			Node forumNode = (Node) getForumHomeNode(sProvider).getSession().getItem(path);
@@ -7216,7 +7140,7 @@
 			} catch (Exception e) {}
 		}catch (Exception e) {
 			log.error("Failed to save prune setting.",e);
-		}finally { sProvider.close() ;}
+		}
 	}
 	
 	private void addOrRemoveSchedule(PruneSetting pSetting) throws Exception {
@@ -7242,7 +7166,7 @@
 	}
 	
 	public void runPrune(PruneSetting pSetting) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try{
 			Node forumHome = getForumHomeNode(sProvider) ;
 			Node forumNode = (Node)forumHome.getSession().getItem(pSetting.getForumPath()) ;
@@ -7272,11 +7196,11 @@
 			forumNode.save() ;
 		}catch (Exception e) {
 			log.error("Failed to run prune",e);
-		}finally {sProvider.close() ;}
+		}
 	}
 	
 	public long checkPrune(PruneSetting pSetting) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try{
 			Node forumHome = getForumHomeNode(sProvider) ;
 			Node forumNode = (Node)forumHome.getSession().getItem(pSetting.getForumPath()) ;
@@ -7290,7 +7214,7 @@
 			return result.getNodes().getSize() ;
 		}catch (Exception e) {
 			log.error("Failed to check prune",e);
-		}finally{ sProvider.close();}
+		}
 		return 0 ;
 	}
 	
@@ -7304,7 +7228,7 @@
 	
 	public List<TopicType> getTopicTypes() throws Exception {
 		List<TopicType> listTT = new ArrayList<TopicType>();
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node nodeHome = getTopicTypeHome(sProvider);
 			NodeIterator iter = nodeHome.getNodes();
@@ -7313,26 +7237,25 @@
 				listTT.add(getTopicType(node));
 			}
 		} catch (Exception e) {
-		}finally { sProvider.close() ;}
+		}
 		return listTT ;
 	}
 	
 	public TopicType getTopicType(String Id) throws Exception {
 		TopicType topicType = new TopicType();
-		 SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		 SessionProvider sProvider = CommonUtils.createSystemProvider();
 			try {
 				Node nodeHome = getTopicTypeHome(sProvider);
 				topicType = getTopicType(nodeHome.getNode(Id));
 			}catch (Exception e) {
 				topicType.setId(TopicType.DEFAULT_ID);
 				topicType.setName(TopicType.DEFAULT_TYPE);
-			}finally { sProvider.close() ;}
+			}
 		return topicType;
 	}
 	
 	public void saveTopicType(TopicType topicType)throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-		try {
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 			Node nodeHome = getTopicTypeHome(sProvider);
 			Node node;
 			try {
@@ -7348,12 +7271,10 @@
 			} else {
 				nodeHome.save();
 			}
-		}finally { sProvider.close() ;}
 	}
 	
 	public void removeTopicType(String topicTypeId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
-		try {
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 			Node nodeHome = getTopicTypeHome(sProvider);
 			try {
 				Node node = nodeHome.getNode(topicTypeId);
@@ -7365,11 +7286,10 @@
 			} else {
 				nodeHome.save();
 			}
-		}finally { sProvider.close() ;}
 	}
 	
 	public JCRPageList getPageTopicByType(String type) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ; 
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node categoryNode = getCategoryHome(sProvider);
 			QueryManager qm = categoryNode.getSession().getWorkspace().getQueryManager();
@@ -7385,14 +7305,14 @@
 			return pagelist;
 		}catch (Exception e) {
 			log.error("Failed to get page topic by type: " + type,e);
-		} finally { sProvider.close() ;}
+		}
 		return null;
 	}
 	
 	
 	public InputStream createForumRss(String objectId, String link) throws Exception {
 		List<SyndEntry> entries = new ArrayList<SyndEntry>() ;
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node node_ = null;
 			if(objectId.indexOf(Utils.CATEGORY) == 0) {
@@ -7418,7 +7338,7 @@
 			return new ByteArrayInputStream(s.getBytes());
 		} catch (Exception e) {
 			e.printStackTrace();
-		}finally { sProvider.close() ;}
+		}
 		return null;
 	}
 	
@@ -7555,7 +7475,7 @@
 	}
 	
 	public InputStream createUserRss(String userId, String link) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider() ;
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		List<SyndEntry> entries = new ArrayList<SyndEntry>();
 		try {
 			Node subscriptionNode = getUserProfileHome(sProvider).getNode(userId+"/"+Utils.FORUM_SUBSCRIOTION+userId);
@@ -7580,7 +7500,7 @@
 			}
 		} catch (Exception e) {
 			log.error("Can not create feed data for user: " + userId, e);
-		}finally {sProvider.close();}
+		}
 		
 		try {
 			SyndFeed feed = new SyndFeedImpl();
@@ -7667,7 +7587,7 @@
 	}
 
 	public String getLatestUser() throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider();
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node profileHome = getUserProfileHome(sProvider);
 			if (profileHome.hasNodes()) {
@@ -7686,19 +7606,15 @@
 			}
 		} catch (Exception e) {
 			e.printStackTrace();
-		} finally {
-			sProvider.close();
 		}
 		return "";
 	}
 
 	public void updateLastLoginDate(String userId) throws Exception {
-		SessionProvider sysProvider = SessionProvider.createSystemProvider() ;
-		try {
+		SessionProvider sysProvider = CommonUtils.createSystemProvider();
 		Node userProfileHome = getUserProfileHome(sysProvider); 
 		userProfileHome.getNode(userId).setProperty(EXO_LAST_LOGIN_DATE, getGreenwichMeanTime()) ;
 		userProfileHome.save() ;
-		}finally{sysProvider.close() ;}
 	}
 
   //get all categories for user can view.
@@ -7812,7 +7728,7 @@
       return getNewPosts(number);
     }
     List<Post> list = new ArrayList<Post>();
-    SessionProvider sProvider = SessionProvider.createSystemProvider();
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       boolean isAdmin = isAdminRole(userName);
       if (!isAdmin) {
@@ -7835,8 +7751,6 @@
       }
     } catch (Exception e) {
       log.debug("Failed to get new post.", e);
-    } finally {
-      sProvider.close();
     }
     return list;
   }
@@ -7844,7 +7758,7 @@
 //the function use to get recent post for everyone.  
   public List<Post> getNewPosts(int number) throws Exception {
     List<Post> list = new ArrayList<Post>();
-    SessionProvider sProvider = SessionProvider.createSystemProvider();
+    SessionProvider sProvider = CommonUtils.createSystemProvider();
     try {
       Node categoryHome = getCategoryHome(sProvider);
       QueryManager qm = categoryHome.getSession().getWorkspace().getQueryManager();
@@ -7860,14 +7774,12 @@
       }
     } catch (Exception e) {
       log.debug("Failed to get new post.", e);
-    } finally {
-      sProvider.close();
     }
     return list;
   }
 	
 	public boolean deleteUserProfile(String userId) throws Exception {
-		SessionProvider sProvider = SessionProvider.createSystemProvider();
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		try {
 			Node profileHome = getUserProfileHome(sProvider);
 			Node profileDeleted ;
@@ -7901,14 +7813,12 @@
 			session.save();
 		} catch (PathNotFoundException e) {
 			return false;
-		} finally {
-			sProvider.close();
 		}
 		return true;
 	}
 
 	public void calculateDeletedUser(String userName) throws Exception	{
-		SessionProvider sProvider = SessionProvider.createSystemProvider();
+		SessionProvider sProvider = CommonUtils.createSystemProvider();
 		String tempUserName = userName;
 		userName = tempUserName.substring(0, tempUserName.indexOf(Utils.DELETED));
 		
@@ -7968,8 +7878,6 @@
 			}
 		} catch (Exception e) {
 			e.printStackTrace();
-		}finally {
-			sProvider.close();
 		}
 	}
 	
Index: eXoApplication/forum/service/src/main/java/org/exoplatform/forum/service/ForumServiceUtils.java
===================================================================
--- eXoApplication/forum/service/src/main/java/org/exoplatform/forum/service/ForumServiceUtils.java	(revision 76510)
+++ eXoApplication/forum/service/src/main/java/org/exoplatform/forum/service/ForumServiceUtils.java	(working copy)
@@ -26,6 +26,7 @@
 
 import org.exoplatform.commons.utils.PageList;
 import org.exoplatform.container.ExoContainerContext;
+import org.exoplatform.ks.common.CommonUtils;
 import org.exoplatform.ks.common.jcr.KSDataLocation;
 import org.exoplatform.ks.common.jcr.SessionManager;
 import org.exoplatform.services.cache.CacheService;
@@ -289,7 +290,7 @@
 	}
 
 	public static SessionProvider getSessionProvider() {
-		return SessionProvider.createSystemProvider();
+		return CommonUtils.createSystemProvider();
 	}
 	
 	
